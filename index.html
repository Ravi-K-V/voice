<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeSpecialist.ai - Optometry Clinical Decision Support with MECS Protocols</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FAFAFA;
            min-height: 100vh;
        }

        .header {
            background-color: #0A3D62;
            color: white;
            padding: 1.5rem;
        }

        .header-content {
            max-width: 64rem;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        .header-subtitle {
            color: #bfdbfe;
            margin: 0;
            font-size: 0.875rem;
        }

        .assessment-header .header-title {
            font-size: 1.25rem;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #bfdbfe;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #1C1C1C;
        }

        .welcome-description {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .disclaimer {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 2rem;
            padding: 0.75rem;
            background-color: #fef3c7;
            border-radius: 0.25rem;
            border-left: 4px solid #f59e0b;
        }

        .condition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .condition-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .condition-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .condition-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .condition-title {
            font-weight: 600;
            font-size: 1.125rem;
            color: #1C1C1C;
            margin: 0;
        }

        .condition-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .condition-pathways {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .progress-container {
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .progress-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1rem;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.5rem;
        }

        .progress-fill {
            height: 0.5rem;
            border-radius: 9999px;
            transition: width 0.3s;
            background-color: #0A3D62;
        }

        .question-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1C1C1C;
        }

        .question-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-button {
            width: 100%;
            padding: 1rem;
            text-align: left;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .option-button:hover {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }

        .red-flags-box {
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .red-flags-title {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .red-flags-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .red-flag-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            color: #7f1d1d;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .clinical-note {
            background-color: #eff6ff;
            border-left: 4px solid #0A3D62;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #374151;
        }

        .navigation-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: space-between;
        }

        .back-tab {
            background: white;
            border: 2px solid #0A3D62;
            color: #0A3D62;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-tab:hover {
            background-color: #0A3D62;
            color: white;
        }

        .back-tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .back-tab:disabled:hover {
            background: white;
            color: #0A3D62;
        }

        .hidden {
            display: none !important;
        }

        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .eye-icon {
            width: 32px;
            height: 32px;
        }

        /* Results Screen Styles */
        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .urgency-icon {
            padding: 0.5rem;
            border-radius: 50%;
            color: white;
        }

        .recommendation-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1C1C1C;
            margin: 0;
        }

        .recommendation-subtitle {
            color: #6b7280;
            margin: 0;
        }

        .reasoning-box {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .reasoning-text {
            color: #374151;
            margin: 0;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1C1C1C;
        }

        .next-steps-box {
            background-color: #eff6ff;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #0A3D62;
        }

        .next-steps-text {
            color: #374151;
            margin: 0;
        }

        .management-box {
            background-color: #f0fdf4;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #22c55e;
            margin-bottom: 1rem;
        }

        .management-title {
            font-weight: 600;
            color: #166534;
            margin-bottom: 0.5rem;
        }

        .management-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .management-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .secondary-button {
            flex: 1;
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .secondary-button:hover {
            background-color: #f9fafb;
        }

        .primary-button {
            flex: 1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            background-color: #0A3D62;
            transition: opacity 0.2s;
        }

        .primary-button:hover {
            opacity: 0.9;
        }

        .section-margin {
            margin-bottom: 1.5rem;
        }

        /* MECS Eligibility Styles */
        .mecs-eligible {
            background-color: #dcfce7;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #166534;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mecs-not-eligible {
            background-color: #fee2e2;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #991b1b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .practice-management-box {
            background-color: #e0f2fe;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #0284c7;
            margin-bottom: 1rem;
        }

        /* MECS Protocol Box */
        .mecs-protocol-box {
            background-color: #fbbf24;
            background-image: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            color: #78350f;
            overflow: hidden;
        }

        .mecs-protocol-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }

        .mecs-protocol-header:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .mecs-protocol-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #451a03;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        .accordion-toggle {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
            stroke: #451a03;
            fill: none;
            stroke-width: 2;
        }

        .accordion-toggle.expanded {
            transform: rotate(180deg);
        }

        .accordion-summary {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
            display: none;
        }

        .pathway-content.expanded + .accordion-summary,
        .mecs-protocol-content.expanded + .accordion-summary {
            display: none;
        }

        .pathway-content:not(.expanded) ~ .accordion-summary,
        .mecs-protocol-content:not(.expanded) ~ .accordion-summary {
            display: block;
        }

        .mecs-protocol-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .mecs-protocol-content.expanded {
            max-height: 2000px;
        }

        .mecs-protocol-inner {
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        .mecs-protocol-subtitle {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #78350f;
        }

        .mecs-protocol-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .mecs-protocol-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: #451a03;
        }

        .mecs-criteria-box {
            background-color: rgba(255, 255, 255, 0.5);
            padding: 1rem;
            border-radius: 0.25rem;
            margin-top: 1rem;
        }

        /* Severity Score Styles */
        .severity-indicator {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .severity-score {
            font-weight: 600;
            color: #1C1C1C;
            margin-bottom: 0.25rem;
        }

        .severity-bar {
            width: 100%;
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .severity-fill {
            height: 100%;
            border-radius: 0.25rem;
            transition: width 0.5s ease;
            background: linear-gradient(to right, #22c55e, #FFC300, #dc3545);
        }

        /* Medication Box Styles */
        .medications-box {
            background-color: #fef3c7;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #f59e0b;
            margin-bottom: 1rem;
        }

        .medications-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        /* Forms and Safety Lists */
        .forms-list, .safety-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .forms-item, .safety-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        /* Pathway Comparison Styles */
        .pathway-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .pathway-section {
            border-radius: 0.5rem;
            background: #f9fafb;
            overflow: hidden;
        }

        .optometry-pathway {
            border-left: 4px solid #0A3D62;
        }

        .ophthalmology-pathway {
            border-left: 4px solid #6366f1;
        }

        .pathway-header {
            padding: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }

        .optometry-pathway .pathway-header {
            background: #f9fafb;
        }

        .ophthalmology-pathway .pathway-header {
            background: #f9fafb;
        }

        .pathway-header:hover {
            background-color: #f3f4f6;
        }

        .pathway-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1C1C1C;
            margin: 0;
        }

        .pathway-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .pathway-content.expanded {
            max-height: 3000px;
        }

        .pathway-inner {
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        @media (max-width: 768px) {
            .pathway-comparison {
                grid-template-columns: 1fr;
            }
        }

        /* Enhanced Indicator */
        .enhanced-indicator {
            background-color: #f0fdf4;
            border-left: 4px solid #22c55e;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #166534;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .enhanced-indicator svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        /* Copy Button */
        .copy-button {
            flex: 1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            background-color: #059669;
            transition: opacity 0.2s;
        }

        .copy-button:hover {
            opacity: 0.9;
        }

        .copy-success {
            background-color: #10b981 !important;
        }

        /* Debug Section */
        .debug-section {
            margin-top: 2rem;
            padding: 1rem;
            background: #f3f4f6;
            border-radius: 0.5rem;
            font-size: 0.75rem;
        }

        .debug-info {
            margin-top: 0.5rem;
            font-family: monospace;
        }

        /* GOS18 Form Styles */
        .gos18-container {
            margin-top: 2rem;
            padding: 1rem;
            background: white;
            border: 2px solid #0A3D62;
            border-radius: 0.5rem;
            position: relative;
            max-width: 100%;
            overflow-x: auto;
        }

        @media (min-width: 768px) {
            .gos18-container {
                padding: 2rem;
            }
        }

        .gos18-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #0A3D62;
        }

        @media (min-width: 768px) {
            .gos18-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .gos18-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #0A3D62;
        }

        @media (min-width: 768px) {
            .gos18-title {
                font-size: 1.5rem;
            }
        }

        .gos18-subtitle {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        @media (min-width: 768px) {
            .gos18-subtitle {
                font-size: 0.875rem;
            }
        }

        .gos18-close {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
            align-self: flex-start;
        }

        .gos18-close:hover {
            background-color: #b91c1c;
        }

        .gos18-form {
            font-size: 0.75rem;
            font-family: 'Arial', sans-serif;
        }

        @media (min-width: 768px) {
            .gos18-form {
                font-size: 0.875rem;
            }
        }

        .gos18-form table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            background: white;
            display: block;
            overflow-x: auto;
        }

        .gos18-form th,
        .gos18-form td {
            border: 1px solid #333;
            padding: 0.25rem;
            text-align: left;
            vertical-align: middle;
            min-width: 60px;
        }

        @media (min-width: 768px) {
            .gos18-form th,
            .gos18-form td {
                padding: 0.5rem;
            }
        }

        .gos18-form th {
            background-color: #f3f4f6;
            font-weight: 600;
        }

        .gos18-form input[type="text"],
        .gos18-form input[type="date"],
        .gos18-form input[type="tel"],
        .gos18-form input[type="email"],
        .gos18-form input[type="time"],
        .gos18-form textarea {
            width: calc(100% - 0.5rem);
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-family: 'Arial', sans-serif;
            background: white;
        }

        @media (min-width: 768px) {
            .gos18-form input[type="text"],
            .gos18-form input[type="date"],
            .gos18-form input[type="tel"],
            .gos18-form input[type="email"],
            .gos18-form input[type="time"],
            .gos18-form textarea {
                font-size: 0.875rem;
            }
        }

        .gos18-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        @media (min-width: 768px) {
            .gos18-form textarea {
                min-height: 80px;
            }
        }

        .gos18-form input[type="checkbox"] {
            margin-right: 0.25rem;
            width: 14px;
            height: 14px;
            vertical-align: middle;
        }

        @media (min-width: 768px) {
            .gos18-form input[type="checkbox"] {
                margin-right: 0.5rem;
                width: 16px;
                height: 16px;
            }
        }

        .gos18-section {
            margin-bottom: 1rem;
        }

        @media (min-width: 768px) {
            .gos18-section {
                margin-bottom: 1.5rem;
            }
        }

        .gos18-section-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            background-color: #e5e7eb;
            padding: 0.375rem;
            border: 1px solid #333;
            text-align: center;
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            .gos18-section-title {
                padding: 0.5rem;
                font-size: 1rem;
            }
        }

        .gos18-responsive-table {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
        }

        .gos18-form .prescription-table {
            min-width: 600px;
        }

        @media (max-width: 767px) {
            .gos18-form td[colspan="6"] {
                display: block;
                width: 100%;
            }
            
            .gos18-form td[rowspan] {
                display: block;
                width: 100%;
                border-bottom: none;
            }
        }

        .gos18-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }

        .gos18-checkbox-item {
            display: flex;
            align-items: center;
            min-width: 150px;
            margin-bottom: 0.25rem;
        }

        @media (max-width: 767px) {
            .gos18-checkbox-item {
                min-width: 100%;
            }
        }

        .gos18-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .gos18-button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .gos18-download {
            background-color: #3b82f6;
            color: white;
            border: none;
        }

        .gos18-download:hover {
            background-color: #2563eb;
        }

        .gos18-email {
            background-color: #10b981;
            color: white;
            border: none;
        }

        .gos18-email:hover {
            background-color: #059669;
        }

        .gos18-toggle {
            background-color: #6366f1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
            font-weight: 500;
            transition: all 0.2s;
        }

        .gos18-toggle:hover {
            background-color: #4f46e5;
        }

        @media print {
            .gos18-close,
            .gos18-actions,
            .gos18-toggle,
            .action-buttons,
            .back-button {
                display: none !important;
            }
        }

        /* Voice Dictation Styles */
        .voice-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .voice-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #0A3D62;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .voice-button:hover {
            background: #083354;
            transform: translateY(-50%) scale(1.1);
        }

        .voice-button.recording {
            background: #dc2626;
            animation: pulse 1.5s infinite;
        }

        .voice-button.processing {
            background: #f59e0b;
        }

        .voice-button svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
            }
        }

        /* Adjust input padding to accommodate voice button */
        .voice-enabled-input {
            padding-right: 40px !important;
        }

        .voice-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            max-width: 300px;
        }

        .voice-status.show {
            display: block;
        }

        /* Voice control panel */
        .voice-control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid #0A3D62;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 999;
            display: none;
        }

        .voice-control-panel.show {
            display: block;
        }

        .voice-toggle-btn {
            background: #0A3D62;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-toggle-btn:hover {
            background: #083354;
        }

        .voice-instructions {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .voice-button {
                width: 32px;
                height: 32px;
            }
            
            .voice-control-panel {
                right: 10px;
                top: 10px;
                padding: 10px;
            }
        }
    </style>
  
    <!-- Add jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" 
            integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" 
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js" 
            integrity="sha512-/PqdfuOzamRlf8iFvQ2582H6wq2WOp5T9hDgAHefQMXLjsSCvqmFLSVIN1xLXnYdBg4USZS6f/78WlnFk+TA0w==" 
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" 
            integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" 
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
   
</head>
<body>
    <!-- Loading indicator -->
    <div id="loading-indicator" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 9999;">
        <div style="font-size: 24px; color: #0A3D62; margin-bottom: 10px;">Loading EyeSpecialist.ai...</div>
        <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #0A3D62; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle">Advanced clinical decision support with integrated MECS protocols</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2 class="welcome-title">Welcome. Select the presenting condition for clinical guidance.</h2>
                <p class="welcome-description">
                    This advanced tool provides evidence-based triage pathways incorporating MECS (Minor Eye Conditions Scheme) protocols, 
                    WOPEC standards, MEH guidelines, and College of Optometrists guidance. Each assessment includes detailed MECS eligibility 
                    criteria and specific management protocols for primary care optometry.
                </p>
                <p class="disclaimer">
                    <strong>Clinical Notice:</strong> This tool incorporates MECS/PEARS pathways with specific protocols for each condition. 
                    MECS enables accredited optometrists to manage acute eye conditions in primary care, reducing secondary care burden. 
                    Always use your clinical judgement and follow local commissioning arrangements.
                </p>
            </div>

            <div class="condition-grid" id="condition-grid">
                <!-- Conditions will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Assessment Screen -->
    <div id="assessment-screen" class="hidden">
        <div class="header assessment-header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle" id="assessment-subtitle">Clinical Assessment</p>
                    </div>
                </div>
                <button class="back-button" onclick="startOver()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12,19 5,12 12,5"></polyline>
                    </svg>
                    Start Over
                </button>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-content">
                <div class="progress-text">
                    <span id="progress-text">Question 1 of 6</span>
                    <span id="progress-percent">17% Complete</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="red-flags-box hidden" id="red-flags-box">
                <h3 class="red-flags-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Red Flags for This Condition
                </h3>
                <ul class="red-flags-list" id="red-flags-list">
                    <!-- Red flags will be populated dynamically -->
                </ul>
            </div>

            <div class="card">
                <h2 class="question-title" id="question-title">Loading question...</h2>
                <p class="question-subtitle hidden" id="question-subtitle"></p>

                <div id="question-options">
                    <!-- Question options will be populated by JavaScript -->
                </div>

                <div class="clinical-note hidden" id="clinical-note"></div>

                <div class="navigation-buttons" id="navigation-buttons">
                    <button class="back-tab" id="back-button" onclick="previousQuestion()" disabled>
                        <svg class="icon" viewBox="0 0 24 24">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12,19 5,12 12,5"></polyline>
                        </svg>
                        Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="results-screen" class="hidden">
        <div class="header assessment-header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle">Clinical Recommendation</p>
                    </div>
                </div>
                <button class="back-button" onclick="startOver()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12,19 5,12 12,5"></polyline>
                    </svg>
                    New Assessment
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <div class="recommendation-header">
                    <div class="urgency-icon" id="urgency-icon">
                        <!-- Icon will be populated by JavaScript -->
                    </div>
                    <div>
                        <h2 class="recommendation-title" id="recommendation-title">Referral</h2>
                        <p class="recommendation-subtitle" id="recommendation-subtitle">Condition</p>
                    </div>
                </div>

                <div class="reasoning-box">
                    <p class="reasoning-text" id="reasoning-text">Reasoning will appear here</p>
                </div>

                <div class="enhanced-indicator" id="enhanced-indicator" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22,4 12,14.01 9,11.01"></polyline>
                    </svg>
                    <span>Enhanced AI analysis applied - comprehensive coverage active</span>
                </div>

                <div class="severity-indicator" id="severity-indicator">
                    <div class="severity-score" id="severity-score">Clinical Severity Score: 0</div>
                    <div class="severity-bar">
                        <div class="severity-fill" id="severity-fill"></div>
                    </div>
                </div>

                <!-- MECS Protocol Box -->
                <div class="mecs-protocol-box" id="mecs-protocol-box" style="display: none;">
                    <div class="mecs-protocol-header" onclick="toggleMECSAccordion()">
                        <h3 class="mecs-protocol-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                            </svg>
                            MECS Protocol
                        </h3>
                        <svg class="accordion-toggle" id="mecs-toggle" viewBox="0 0 24 24">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="mecs-protocol-content" id="mecs-protocol-content">
                        <div class="mecs-protocol-inner" id="mecs-protocol-inner">
                            <!-- MECS protocol details will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Pathway Comparison Section -->
                <div class="pathway-comparison">
                    <!-- Optometry Pathway -->
                    <div class="pathway-section optometry-pathway">
                        <div class="pathway-header" onclick="togglePathwayAccordion('optometry')">
                            <h3 class="pathway-title">Optometry Management Pathway</h3>
                            <svg class="accordion-toggle" id="optometry-toggle" viewBox="0 0 24 24">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                        <div class="pathway-content expanded" id="optometry-content">
                            <div class="pathway-inner">
                                <div class="section-margin">
                                    <h4 class="section-title">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-11v6h2v-6h-2zm0-4v2h2V7h-2z"></path>
                                        </svg>
                                        Practice Management
                                    </h4>
                                    <div class="practice-management-box">
                                        <div id="mecs-eligibility">
                                            <!-- MECS eligibility will be populated -->
                                        </div>
                                    </div>
                                </div>

                                <div class="section-margin">
                                    <h4 class="section-title">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="16" y1="13" x2="8" y2="13"></line>
                                            <line x1="16" y1="17" x2="8" y2="17"></line>
                                            <polyline points="10 9 9 9 8 9"></polyline>
                                        </svg>
                                        Primary Care Management
                                    </h4>
                                    <div class="management-box">
                                        <ul class="management-list" id="optometry-management">
                                            <!-- Optometry management steps will be populated -->
                                        </ul>
                                    </div>
                                    <div class="medications-box" id="optometry-medications-box">
                                        <h4 class="medications-title">Medications (Optometry)</h4>
                                        <ul class="management-list" id="optometry-medications-list">
                                            <!-- Medications will be populated -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ophthalmology Pathway -->
                    <div class="pathway-section ophthalmology-pathway">
                        <div class="pathway-header" onclick="togglePathwayAccordion('ophthalmology')">
                            <h3 class="pathway-title">If Referred to Ophthalmology</h3>
                            <svg class="accordion-toggle" id="ophthalmology-toggle" viewBox="0 0 24 24">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                        <div class="pathway-content" id="ophthalmology-content">
                            <div class="pathway-inner">
                                <div class="section-margin">
                                    <h4 class="section-title">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <polyline points="9,18 15,12 9,6"></polyline>
                                        </svg>
                                        Secondary Care Triage
                                    </h4>
                                    <div class="next-steps-box">
                                        <p class="next-steps-text" id="ophthalmology-triage">Secondary care pathway will appear here</p>
                                    </div>
                                </div>

                                <div class="section-margin">
                                    <h4 class="section-title">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                                        </svg>
                                        Hospital Management
                                    </h4>
                                    <div class="management-box">
                                        <ul class="management-list" id="ophthalmology-management">
                                            <!-- Ophthalmology management steps will be populated -->
                                        </ul>
                                    </div>
                                    <div class="medications-box" id="ophthalmology-medications-box">
                                        <h4 class="medications-title">Medications (Hospital)</h4>
                                        <ul class="management-list" id="ophthalmology-medications-list">
                                            <!-- Hospital medications will be populated -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                        </svg>
                        Documentation Required
                    </h3>
                    <ul class="forms-list" id="forms-list">
                        <!-- Forms will be populated by JavaScript -->
                    </ul>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Safety-Netting Advice
                    </h3>
                    <ul class="safety-list" id="safety-list">
                        <!-- Safety netting advice will be populated by JavaScript -->
                    </ul>
                </div>
            </div>

            <!-- GOS18 Form Toggle Button -->
            <button class="gos18-toggle" onclick="toggleGOS18Form()">
                <svg class="icon" viewBox="0 0 24 24" style="display: inline-block; margin-right: 0.5rem;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                Generate GOS18 Referral Form
            </button>

            <!-- GOS18 Form Container -->
            <div id="gos18-form-container" class="gos18-container hidden">
                <div class="gos18-header">
                    <div>
                        <h3 class="gos18-title">GOS 18</h3>
                        <p class="gos18-subtitle">Referral/Notification (Always at optometrist)</p>
                        <p class="gos18-subtitle">Please contact the patient if they do not contact you or do not attend</p>
                    </div>
                    <button class="gos18-close" onclick="hideGOS18Form()">âœ• Close</button>
                </div>

                <form id="gos18-form" class="gos18-form">
                    <!-- Patient Details Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">CONSULTATION DATE / Patient Details</div>
                        <table>
                            <tr>
                                <td><strong>Title:</strong></td>
                                <td><input type="text" name="title" placeholder="Mr/Mrs/Miss/Ms/Other"></td>
                                <td><strong>DoB:</strong></td>
                                <td><input type="date" name="dob"></td>
                                <td rowspan="3"><strong>Address:</strong></td>
                                <td rowspan="3"><textarea name="address" rows="3"></textarea></td>
                            </tr>
                            <tr>
                                <td><strong>Surname:</strong></td>
                                <td><input type="text" name="surname"></td>
                                <td><strong>Tel (H):</strong></td>
                                <td><input type="tel" name="telHome"></td>
                            </tr>
                            <tr>
                                <td><strong>First Names:</strong></td>
                                <td><input type="text" name="firstName"></td>
                                <td><strong>Tel (M):</strong></td>
                                <td><input type="tel" name="telMobile"></td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <strong>Other:</strong> <input type="text" name="other" style="width: 90%;">
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <strong>Post Code:</strong> <input type="text" name="postcode" style="width: 200px;">
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- GP Details Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">GP Details / Optometrist Details</div>
                        <table>
                            <tr>
                                <td><strong>Name Address:</strong></td>
                                <td><input type="text" name="gpName"></td>
                                <td><strong>Name Address:</strong></td>
                                <td><input type="text" name="optName"></td>
                            </tr>
                            <tr>
                                <td><strong>E-Mail:</strong></td>
                                <td><input type="email" name="gpEmail"></td>
                                <td><strong>E-Mail:</strong></td>
                                <td><input type="email" name="optEmail"></td>
                            </tr>
                            <tr>
                                <td><strong>Tel:</strong></td>
                                <td><input type="tel" name="gpTel"></td>
                                <td><strong>Tel:</strong></td>
                                <td><input type="tel" name="optTel"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Latest Spectacle Prescription Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">Latest Spectacle Prescription</div>
                        <div class="gos18-responsive-table">
                            <table class="prescription-table">
                                <thead>
                                    <tr>
                                        <th>Rx</th>
                                        <th>Vision</th>
                                        <th>Sph</th>
                                        <th>Cyl</th>
                                        <th>Axis</th>
                                        <th>VA</th>
                                        <th>Dist. Prism PH Acuity</th>
                                        <th>Add</th>
                                        <th>Nr. Prism</th>
                                        <th>Near VA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>RE</td>
                                        <td><input type="text" name="reVision"></td>
                                        <td><input type="text" name="reSph"></td>
                                        <td><input type="text" name="reCyl"></td>
                                        <td><input type="text" name="reAxis"></td>
                                        <td><input type="text" name="reVA"></td>
                                        <td><input type="text" name="reDistPrism"></td>
                                        <td><input type="text" name="reAdd"></td>
                                        <td><input type="text" name="reNrPrism"></td>
                                        <td><input type="text" name="reNearVA"></td>
                                    </tr>
                                    <tr>
                                        <td>LE</td>
                                        <td><input type="text" name="leVision"></td>
                                        <td><input type="text" name="leSph"></td>
                                        <td><input type="text" name="leCyl"></td>
                                        <td><input type="text" name="leAxis"></td>
                                        <td><input type="text" name="leVA"></td>
                                        <td><input type="text" name="leDistPrism"></td>
                                        <td><input type="text" name="leAdd"></td>
                                        <td><input type="text" name="leNrPrism"></td>
                                        <td><input type="text" name="leNearVA"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Clinical Findings Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">IT Fields / Provisional Diagnosis</div>
                        <table>
                            <tr>
                                <td><strong>Imaging:</strong></td>
                                <td colspan="5">
                                    <input type="checkbox" name="imaging1"> Enclosed
                                    <input type="checkbox" name="imaging2"> Emailed
                                    <input type="checkbox" name="imaging3"> Sent with patient
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <strong>Salient Symptoms, Signs, History, Clinical Findings, Reason for Referral and Provisional Diagnosis:</strong><br>
                                    <textarea name="clinicalFindings" rows="4" style="width: 100%;" id="gos18-clinical-findings"></textarea>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Safety Netting Advice Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">Safety-Netting Advice Given to Patient</div>
                        <table>
                            <tr>
                                <td colspan="6">
                                    <strong>Patient advised regarding symptoms requiring immediate return:</strong><br>
                                    <textarea name="safetyNettingAdvice" rows="3" style="width: 100%;" id="gos18-safety-netting"></textarea>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Referral Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">Referral</div>
                        <table>
                            <tr>
                                <td colspan="6">
                                    <div class="gos18-checkbox-group">
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralHES" id="referralHES"> 
                                            <label for="referralHES">HES</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralOcular" id="referralOcular"> 
                                            <label for="referralOcular">Ocular Emergency - to Hospital A&E Eye Service</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralSemi" id="referralSemi"> 
                                            <label for="referralSemi">Semi-Urgent - to HES within 4 weeks</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralRoutine" id="referralRoutine"> 
                                            <label for="referralRoutine">Routine - to HES within 12 weeks</label>
                                        </div>
                                    </div>
                                    
                                    <strong>Supervised by:</strong><br>
                                    <div class="gos18-checkbox-group">
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedCataract"> 
                                            <label>Cataract</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedGeneral"> 
                                            <label>General (Medical/Ophthalmology)</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedDiabetic"> 
                                            <label>Diabetic/Dis/Adv</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedLow"> 
                                            <label>Low Vision</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedOther"> 
                                            <label>Other Medical Retinal</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedGlaucoma"> 
                                            <label>Glaucoma</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedSquint"> 
                                            <label>Squint/Ocular Motility</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedYAG"> 
                                            <label>YAG Laser</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedAdnexal"> 
                                            <label>Paed: Adnexal/Orbits</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedExternal"> 
                                            <label>External Eye/Adnexa</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedOrtho"> 
                                            <label>Orthoptics</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedMacular"> 
                                            <label>Macular/Intravitreal</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedPaed"> 
                                            <label>Paed: General/Refrac</label>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 0.5rem;">
                                        <strong>Not otherwise specified:</strong> 
                                        <input type="text" name="notSpecified" style="width: 50%;">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <div class="gos18-checkbox-group" style="margin-top: 1rem;">
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralGP"> 
                                            <label>GP (For Systemic management or appropriate)</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralNotification"> 
                                            <label>Notification Only</label>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Optometrist Details Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">Optometrist Name / Date</div>
                        <table>
                            <tr>
                                <td><strong>Signature:</strong></td>
                                <td><input type="text" name="optSignature" placeholder="Type name"></td>
                                <td><strong>GOC No:</strong></td>
                                <td><input type="text" name="gocNumber"></td>
                                <td><strong>Date:</strong></td>
                                <td><input type="date" name="referralDate" id="referralDate"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Footer Note -->
                    <div class="gos18-section">
                        <p style="font-size: 0.75rem; text-align: center; color: #6b7280;">
                            Please obtain consent from the patient if not already given, and provide feedback to the referring optometrist Referral Letter:<br>
                            <input type="checkbox" name="patientCopy"> Patient Copy
                            <input type="checkbox" name="postedToGP"> Posted to GP
                            <input type="checkbox" name="handedToPatient"> Handed to Pt to take to GP/HES
                            <input type="checkbox" name="faxedToHES"> Faxed to HES<br>
                            GOS018 Unrelated Excel.xlsx
                        </p>
                    </div>
                </form>

                <div class="gos18-actions">
                    <button type="button" class="gos18-button gos18-download" onclick="downloadGOS18()">
                        <svg class="icon" viewBox="0 0 24 24" style="display: inline-block; margin-right: 0.5rem;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download PDF
                    </button>
                    <button type="button" class="gos18-button gos18-email" onclick="emailGOS18()">
                        <svg class="icon" viewBox="0 0 24 24" style="display: inline-block; margin-right: 0.5rem;">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        Email Form
                    </button>
                </div>
            </div>

            <div class="action-buttons">
                <button class="secondary-button" onclick="startOver()">New Assessment</button>
                <button class="copy-button" id="copy-button" onclick="copyAssessmentResults()">Copy Assessment</button>
                <button class="primary-button" onclick="window.print()">Generate Referral Letter</button>
            </div>
            
            <!-- Debug section -->
            <div class="debug-section">
                <strong>Debug Info:</strong>
                <div class="debug-info">
                    Urgency: <span id="debug-urgency"></span><br>
                    Severity Score: <span id="debug-score"></span><br>
                    Match Type: <span id="debug-match"></span><br>
                    Pathway: <span id="debug-pathway"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentStep = 'welcome';
        let selectedCondition = null;
        let responses = {};
        let currentQuestionIndex = 0;
        let assessmentPath = [];
        let recommendation = null;
        let questionHistory = [];
        
        // Maximum possible scores for each condition
        const maxScores = {
            "Red Eye": 29,
            "Flashes & Floaters": 24,
            "Sudden Vision Loss": 25,
            "Raised IOP": 20,
            "Eyelid Problems": 26,
            "Watery Eyes": 15,
            "Pediatric Eye Problems": 24,
            "Diplopia": 20,
            "Headaches with Visual Symptoms": 23,
            "Corneal Problems": 27
        };

        // MECS Protocol Data
        const mecsProtocols = {
            "Red Eye": {
                eligible: true,
                overview: "MECS allows management of most red eye presentations in primary care. Excludes post-operative cases and severe sight-threatening conditions.",
                conditions: {
                    "Bacterial conjunctivitis": {
                        criteria: [
                            "Purulent discharge",
                            "No vision loss",
                            "No severe pain",
                            "No recent surgery"
                        ],
                        management: [
                            "Chloramphenicol 0.5% drops QDS for 2 days then BD for 5 days",
                            "Or Fusidic acid 1% gel BD for 7 days",
                            "Hygiene advice - avoid sharing towels",
                            "Review if not improving in 48-72 hours"
                        ],
                        billing: "MECS Band 1 - acute presentation"
                    },
                    "Viral conjunctivitis": {
                        criteria: [
                            "Watery discharge",
                            "Follicular reaction",
                            "May have pre-auricular node",
                            "Often bilateral"
                        ],
                        management: [
                            "Cool compresses",
                            "Lubricants PRN",
                            "Strict hygiene measures",
                            "Warn highly contagious for 2 weeks",
                            "No antibiotics unless secondary infection"
                        ],
                        billing: "MECS Band 1"
                    },
                    "Allergic conjunctivitis": {
                        criteria: [
                            "Bilateral symptoms",
                            "Itching prominent",
                            "Chemosis common",
                            "History of allergy"
                        ],
                        management: [
                            "Sodium cromoglicate 2% QDS",
                            "Or Olopatadine 0.1% BD",
                            "Cool compresses",
                            "Allergen avoidance",
                            "Oral antihistamines if systemic symptoms"
                        ],
                        billing: "MECS Band 1"
                    },
                    "Anterior uveitis": {
                        criteria: [
                            "Ciliary injection",
                            "Photophobia",
                            "Small pupil",
                            "AC cells/flare"
                        ],
                        management: [
                            "URGENT same-day referral",
                            "Cyclopentolate 1% STAT",
                            "NO steroids without specialist",
                            "Document pupil reactions"
                        ],
                        billing: "MECS Band 2 - urgent referral required"
                    }
                },
                documentation: [
                    "Visual acuity both eyes",
                    "Pupil reactions",
                    "Anterior segment findings",
                    "IOP if equipment available",
                    "Fundus check if dilated"
                ]
            },
            "Flashes & Floaters": {
                eligible: true,
                overview: "MECS covers assessment of vitreoretinal symptoms. Requires dilated fundus examination. Urgent referral if retinal pathology found.",
                conditions: {
                    "Posterior vitreous detachment": {
                        criteria: [
                            "Acute onset floaters",
                            "Photopsia",
                            "No field defect",
                            "Clear media"
                        ],
                        management: [
                            "Full dilated examination mandatory",
                            "Document Weiss ring if visible",
                            "Three-mirror or indirect assessment",
                            "If no tear found - review in 4-6 weeks",
                            "Clear safety-netting advice"
                        ],
                        billing: "MECS Band 2 - requires dilation"
                    },
                    "Retinal tear": {
                        criteria: [
                            "Vitreous pigment (tobacco dust)",
                            "Vitreous hemorrhage",
                            "Visible tear on examination"
                        ],
                        management: [
                            "IMMEDIATE referral to HES",
                            "Phone ahead to eye casualty",
                            "Advise posturing if appropriate",
                            "Document location and size"
                        ],
                        billing: "MECS Band 2 - emergency referral"
                    },
                    "Retinal detachment": {
                        criteria: [
                            "Field defect",
                            "Reduced vision",
                            "Detached retina visible"
                        ],
                        management: [
                            "EMERGENCY referral",
                            "Nil by mouth",
                            "Posture face-down if macula-on",
                            "Arrange immediate transport"
                        ],
                        billing: "MECS Band 2 - emergency"
                    }
                },
                documentation: [
                    "Detailed symptom history",
                    "Visual acuity",
                    "Visual fields by confrontation",
                    "Dilated fundus drawing",
                    "Document all retinal areas examined"
                ]
            },
            "Sudden Vision Loss": {
                eligible: false,
                overview: "Most sudden vision loss cases EXCEED MECS scope due to urgency and need for immediate medical intervention. Direct HES referral usually required.",
                exclusions: [
                    "CRAO/CRVO - needs immediate hospital assessment",
                    "GCA - requires immediate steroids",
                    "Retinal detachment - surgical emergency",
                    "Acute glaucoma - medical emergency"
                ],
                exceptions: {
                    "Migraine with aura": {
                        criteria: [
                            "Typical pattern",
                            "Previous episodes",
                            "Complete recovery",
                            "Age <50"
                        ],
                        management: [
                            "Reassurance if typical",
                            "GP referral for prophylaxis",
                            "Advise return if different pattern"
                        ]
                    }
                }
            },
            "Raised IOP": {
                eligible: true,
                overview: "MECS covers ocular hypertension and chronic glaucoma monitoring. Acute angle closure requires emergency referral.",
                conditions: {
                    "Ocular hypertension": {
                        criteria: [
                            "IOP 22-30 mmHg",
                            "No symptoms",
                            "Open angles",
                            "Normal discs"
                        ],
                        management: [
                            "Repeat IOP check",
                            "Pachymetry if available",
                            "Disc photos/OCT if available",
                            "Risk stratification",
                            "Refer to glaucoma service if needed"
                        ],
                        billing: "MECS Band 1"
                    },
                    "Chronic glaucoma": {
                        criteria: [
                            "Known glaucoma patient",
                            "Stable on treatment",
                            "Routine monitoring"
                        ],
                        management: [
                            "IOP check",
                            "Compliance check",
                            "Visual fields if equipped",
                            "Report to glaucoma service"
                        ],
                        billing: "May be under local glaucoma scheme"
                    },
                    "Acute angle closure": {
                        criteria: [
                            "IOP >35 mmHg",
                            "Pain and nausea",
                            "Fixed mid-dilated pupil",
                            "Corneal edema"
                        ],
                        management: [
                            "EMERGENCY referral",
                            "Acetazolamide 500mg STAT if available",
                            "Pilocarpine 2% to both eyes",
                            "Analgesia"
                        ],
                        billing: "NOT MECS - emergency pathway"
                    }
                },
                documentation: [
                    "IOP both eyes (multiple readings)",
                    "Gonioscopy findings if trained",
                    "Disc assessment",
                    "Previous IOP records"
                ]
            },
            "Eyelid Problems": {
                eligible: true,
                overview: "MECS covers benign lid conditions and infections. Suspected malignancy or orbital involvement requires secondary care.",
                conditions: {
                    "Blepharitis": {
                        criteria: [
                            "Lid margin inflammation",
                            "Chronic symptoms",
                            "No systemic features"
                        ],
                        management: [
                            "Hot compresses BD",
                            "Lid hygiene with baby shampoo",
                            "Lubricants QDS",
                            "Consider doxycycline 100mg OD if severe",
                            "Patient education crucial"
                        ],
                        billing: "MECS Band 1"
                    },
                    "Chalazion": {
                        criteria: [
                            "Non-infected lid swelling",
                            "No systemic symptoms",
                            "Clear diagnosis"
                        ],
                        management: [
                            "Hot compresses QDS",
                            "Massage after heat",
                            "May take 2-3 months to resolve",
                            "Refer if persistent >3 months"
                        ],
                        billing: "MECS Band 1"
                    },
                    "Preseptal cellulitis": {
                        criteria: [
                            "Lid swelling and erythema",
                            "Normal eye movements",
                            "No proptosis",
                            "Systemically well"
                        ],
                        management: [
                            "Co-amoxiclav 625mg TDS 7 days",
                            "Mark extent of erythema",
                            "Review in 24-48 hours",
                            "Admit if not improving"
                        ],
                        billing: "MECS Band 2 - requires follow-up"
                    },
                    "Orbital cellulitis": {
                        criteria: [
                            "Proptosis",
                            "Restricted eye movements",
                            "Systemic symptoms"
                        ],
                        management: [
                            "NOT MECS ELIGIBLE",
                            "IMMEDIATE admission",
                            "IV antibiotics required"
                        ],
                        billing: "Emergency pathway"
                    }
                },
                documentation: [
                    "Lid position and function",
                    "Eye movements",
                    "Presence of proptosis",
                    "Systemic observations if unwell"
                ]
            },
            "Corneal Problems": {
                eligible: true,
                overview: "MECS covers corneal abrasions, foreign bodies, and minor keratitis. Contact lens keratitis needs urgent referral.",
                conditions: {
                    "Corneal abrasion": {
                        criteria: [
                            "History of trauma",
                            "Epithelial defect",
                            "No infiltrate",
                            "No contact lens wear"
                        ],
                        management: [
                            "Chloramphenicol 1% QDS 5 days",
                            "Lubricants QDS",
                            "Oral analgesia",
                            "No patching",
                            "Review if not healed in 48h"
                        ],
                        billing: "MECS Band 1"
                    },
                    "Corneal foreign body": {
                        criteria: [
                            "Visible FB",
                            "Superficial location",
                            "No rust ring",
                            "No penetration concern"
                        ],
                        management: [
                            "Remove with needle/spud",
                            "Chloramphenicol QDS 5 days",
                            "Review next day if rust ring",
                            "Advise on eye protection"
                        ],
                        billing: "MECS Band 2 - procedure"
                    },
                    "Contact lens keratitis": {
                        criteria: [
                            "CL wearer with pain",
                            "Infiltrate present",
                            "Vision affected"
                        ],
                        management: [
                            "URGENT same-day referral",
                            "Stop CL wear immediately",
                            "Keep lenses and case for culture",
                            "NO treatment before scraping"
                        ],
                        billing: "MECS Band 2 - urgent referral"
                    },
                    "Herpetic keratitis": {
                        criteria: [
                            "Dendritic ulcer",
                            "Reduced corneal sensation",
                            "History of cold sores"
                        ],
                        management: [
                            "Aciclovir 3% ointment 5x daily",
                            "NO steroids",
                            "Urgent ophthalmology review",
                            "May need oral antivirals"
                        ],
                        billing: "MECS Band 2"
                    }
                },
                documentation: [
                    "Size and location of defect",
                    "Presence of infiltrate",
                    "AC activity",
                    "Drawing/photo if possible"
                ]
            },
            "Watery Eyes": {
                eligible: true,
                overview: "MECS covers epiphora assessment. Can manage simple causes but nasolacrimal obstruction needs referral.",
                conditions: {
                    "Reflex tearing": {
                        criteria: [
                            "Dry eye symptoms",
                            "Blepharitis present",
                            "Bilateral symptoms"
                        ],
                        management: [
                            "Treat underlying cause",
                            "Lubricants QDS",
                            "Lid hygiene if blepharitis",
                            "Review in 4 weeks"
                        ],
                        billing: "MECS Band 1"
                    },
                    "Ectropion": {
                        criteria: [
                            "Lid malposition visible",
                            "Tears overflow",
                            "Exposure symptoms"
                        ],
                        management: [
                            "Lubricant ointment nocte",
                            "Tape lid at night if severe",
                            "Routine oculoplastics referral",
                            "Protect cornea"
                        ],
                        billing: "MECS Band 1"
                    },
                    "Nasolacrimal obstruction": {
                        criteria: [
                            "Epiphora without reflex cause",
                            "Positive regurgitation test",
                            "History of dacryocystitis"
                        ],
                        management: [
                            "Routine lacrimal clinic referral",
                            "Advise DCR may be needed",
                            "Treat infection if present"
                        ],
                        billing: "MECS Band 1"
                    }
                },
                documentation: [
                    "Lid position",
                    "Punctal assessment",
                    "Regurgitation test",
                    "Tear film assessment"
                ]
            },
            "Pediatric Eye Problems": {
                eligible: false,
                overview: "Most pediatric cases EXCEED MECS scope. Children need specialist assessment. Some areas have separate pediatric schemes.",
                exclusions: [
                    "White pupil - urgent referral",
                    "Squint - orthoptic assessment",
                    "Amblyopia - hospital pathway",
                    "Congenital abnormalities"
                ],
                exceptions: {
                    "Simple conjunctivitis": {
                        criteria: [
                            "Age >2 years",
                            "Clear diagnosis",
                            "No vision concern",
                            "Cooperative child"
                        ],
                        management: [
                            "As per adult protocols",
                            "Consider school exclusion",
                            "Parental education"
                        ]
                    }
                }
            },
            "Diplopia": {
                eligible: false,
                overview: "Diplopia usually EXCEEDS MECS scope due to potential neurological causes. Most need urgent medical assessment.",
                exclusions: [
                    "New onset binocular diplopia",
                    "Cranial nerve palsies",
                    "Associated neurological signs"
                ],
                documentation: [
                    "Cover test findings",
                    "Which direction worst",
                    "Associated symptoms"
                ]
            },
            "Headaches with Visual Symptoms": {
                eligible: false,
                overview: "Generally EXCEEDS MECS scope. Risk of missing serious pathology. Needs medical assessment.",
                exclusions: [
                    "Papilledema",
                    "New headache >50 years",
                    "Neurological signs"
                ],
                exceptions: {
                    "Typical migraine": {
                        criteria: [
                            "Classic pattern",
                            "Previous diagnosis",
                            "No red flags"
                        ],
                        management: [
                            "GP management",
                            "Trigger diary",
                            "Prophylaxis if frequent"
                        ]
                    }
                }
            }
        };

        // Combined clinical data from both files
        const clinicalData = {
            "Red Eye": {
                description: "Comprehensive assessment for red eye presentations including infection, inflammation, and sight-threatening conditions",
                pathways: ["Unilateral", "Bilateral", "Contact lens-related", "Post-operative"],
                redFlags: [
                    "Recent cataract surgery or intravitreal injection (last 4 weeks)",
                    "Severe headache with vomiting",
                    "Pain waking patient at night",
                    "Reduced vision",
                    "Contact lens wearer with symptoms",
                    "Preceding trauma (blunt/high velocity/chemical)"
                ],
                questions: [
                    {
                        id: "laterality",
                        text: "Is the red eye unilateral or bilateral?",
                        options: ["Unilateral", "Bilateral"],
                        clinicalNote: "Bilateral red eye often suggests allergic or infective causes, while unilateral may indicate more serious pathology"
                    },
                    {
                        id: "recent_surgery",
                        text: "Has the patient had recent eye surgery or injection?",
                        subtitle: "Within the last 4 weeks",
                        options: ["Yes", "No"],
                        clinicalNote: "Post-operative red eye requires urgent assessment to exclude endophthalmitis"
                    },
                    {
                        id: "contact_lens",
                        text: "Is the patient a contact lens wearer?",
                        options: ["Yes", "No"],
                        clinicalNote: "Contact lens-related keratitis requires different management and has higher risk"
                    },
                    {
                        id: "pain_severity",
                        text: "What is the severity of pain?",
                        options: ["No pain", "Mild discomfort", "Severe pain with photophobia"],
                        clinicalNote: "Severe pain with photophobia suggests serious pathology (uveitis, keratitis, scleritis)"
                    },
                    {
                        id: "discharge",
                        text: "Is there discharge present?",
                        subtitle: "Note the type if present",
                        options: ["No discharge", "Watery discharge", "Mucopurulent discharge"],
                        clinicalNote: "Mucopurulent suggests bacterial; watery suggests viral or allergic"
                    },
                    {
                        id: "vision_affected",
                        text: "Is vision affected?",
                        options: ["Normal vision", "Mild blur", "Significant vision loss"],
                        clinicalNote: "Vision loss with red eye is always concerning and requires urgent assessment"
                    },
                    {
                        id: "pupil_size",
                        text: "Compare pupil size in affected eye",
                        options: ["Smaller/same as other eye", "Larger than other eye", "Fixed and dilated"],
                        clinicalNote: "Large pupil with red eye suggests acute angle closure glaucoma"
                    },
                    {
                        id: "corneal_staining",
                        text: "Does the cornea stain with fluorescein?",
                        subtitle: "If fluorescein available",
                        options: ["No staining", "Punctate staining", "Epithelial defect", "Dendritic pattern", "Not tested"],
                        clinicalNote: "Dendritic pattern suggests herpetic keratitis; never use steroids without specialist input"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["recent_surgery:Yes", "vision_affected:Significant vision loss"],
                        condition: "Post-operative complication with vision loss",
                        management: "IMMEDIATE ophthalmology referral - ?endophthalmitis"
                    },
                    urgent: {
                        criteria: ["vision_affected:Significant vision loss", "pain_severity:Severe pain with photophobia"],
                        condition: "Possible uveitis, keratitis, or acute glaucoma",
                        management: "Same-day ophthalmology referral required"
                    },
                    routine: {
                        criteria: ["discharge:Mucopurulent discharge", "vision_affected:Normal vision"],
                        condition: "Likely bacterial conjunctivitis",
                        management: "Chloramphenicol QDS 7 days, review if no improvement"
                    }
                }
            },
            "Flashes & Floaters": {
                description: "Assessment for posterior vitreous detachment and retinal pathology",
                pathways: ["Acute onset", "Chronic symptoms", "High-risk features"],
                redFlags: [
                    "Shower of floaters/cobwebs",
                    "Progressive visual field loss",
                    "Curtain/shadow in vision",
                    "Recent onset arc-like flashes",
                    "High myopia (>-6D)",
                    "Previous retinal detachment"
                ],
                questions: [
                    {
                        id: "onset_timing",
                        text: "When did symptoms begin?",
                        options: ["Within 24 hours", "Within 1 week", "Within 1 month", "Over 1 month ago"],
                        clinicalNote: "Acute onset requires urgent assessment to exclude retinal tear"
                    },
                    {
                        id: "floater_increase",
                        text: "Have floaters increased?",
                        subtitle: "Compare to baseline",
                        options: ["Yes - shower of floaters", "Yes - few new floaters", "No change", "First time floaters"],
                        clinicalNote: "Shower of floaters suggests vitreous hemorrhage from retinal tear"
                    },
                    {
                        id: "visual_field",
                        text: "Any visual field loss?",
                        subtitle: "Shadow, curtain, or missing area",
                        options: ["Yes - progressive", "Yes - stable", "No"],
                        clinicalNote: "Progressive field loss indicates retinal detachment requiring emergency surgery"
                    },
                    {
                        id: "flash_pattern",
                        text: "Describe the flashes",
                        options: ["Arc-like flashes in periphery", "Central sparkles", "Zigzag patterns", "No flashes"],
                        clinicalNote: "Peripheral arc flashes suggest vitreoretinal traction"
                    },
                    {
                        id: "risk_factors",
                        text: "Risk factors present?",
                        options: ["High myopia (>-6D)", "Previous retinal problems", "Recent eye surgery", "Family history RD", "None"],
                        clinicalNote: "Multiple risk factors significantly increase retinal detachment risk"
                    },
                    {
                        id: "vision_quality",
                        text: "Current vision quality?",
                        options: ["Normal", "Slightly blurred", "Significantly reduced"],
                        clinicalNote: "Vision loss with flashes/floaters is concerning for detachment"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["visual_field:Yes - progressive"],
                        condition: "Probable retinal detachment",
                        management: "IMMEDIATE ophthalmology referral - same day"
                    },
                    urgent: {
                        criteria: ["onset_timing:Within 24 hours", "floater_increase:Yes - shower of floaters"],
                        condition: "Acute PVD with high risk of tear",
                        management: "Urgent dilated examination within 24-48 hours"
                    },
                    routine: {
                        criteria: ["onset_timing:Over 1 month ago", "visual_field:No"],
                        condition: "Chronic floaters - likely benign",
                        management: "Routine referral if symptomatic"
                    }
                }
            },
            "Sudden Vision Loss": {
                description: "Rapid assessment for acute vision loss - time-critical pathology",
                pathways: ["Vascular", "Inflammatory", "Retinal", "Neurological"],
                redFlags: [
                    "Complete vision loss",
                    "Giant cell arteritis symptoms",
                    "RAPD present",
                    "Cherry red spot",
                    "Pale swollen disc",
                    "Age >50 with headache"
                ],
                questions: [
                    {
                        id: "laterality",
                        text: "Which eye(s) affected?",
                        options: ["One eye (monocular)", "Both eyes (binocular)", "Unsure"],
                        clinicalNote: "Monocular suggests ocular pathology; binocular suggests neurological"
                    },
                    {
                        id: "onset_pattern",
                        text: "Speed of vision loss?",
                        options: ["Sudden (seconds)", "Rapid (minutes)", "Gradual (hours)", "Progressive (days)"],
                        clinicalNote: "Instantaneous loss suggests vascular occlusion"
                    },
                    {
                        id: "pain_present",
                        text: "Is there associated pain?",
                        options: ["No pain", "Mild discomfort", "Severe pain", "Pain on eye movement"],
                        clinicalNote: "Painless loss often vascular; painful suggests inflammatory/glaucoma"
                    },
                    {
                        id: "gca_symptoms",
                        text: "Any GCA symptoms?",
                        subtitle: "If age >50",
                        options: ["Temporal headache", "Jaw claudication", "Scalp tenderness", "None", "Multiple symptoms"],
                        clinicalNote: "GCA requires IMMEDIATE high-dose steroids to save vision"
                    },
                    {
                        id: "visual_pattern",
                        text: "Pattern of vision loss?",
                        options: ["Complete blackout", "Central scotoma", "Altitudinal defect", "Curtain-like", "Patchy loss"],
                        clinicalNote: "Pattern helps localize: altitudinal=AION, central=macular, curtain=amaurosis/RD"
                    },
                    {
                        id: "duration",
                        text: "Is vision loss persistent?",
                        options: ["Yes - persistent", "<5 minutes", "5-30 minutes", ">30 minutes", "Recurring episodes"],
                        clinicalNote: "Transient loss (amaurosis fugax) predicts stroke risk"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["gca_symptoms:Jaw claudication"],
                        condition: "Giant cell arteritis suspected",
                        management: "START PREDNISOLONE 60-80mg IMMEDIATELY, urgent ESR/CRP"
                    },
                    urgent: {
                        criteria: ["onset_pattern:Sudden (seconds)", "pain_present:No pain"],
                        condition: "Possible CRAO or CRVO",
                        management: "IMMEDIATE ophthalmology assessment required"
                    },
                    routine: {
                        criteria: ["onset_pattern:Progressive (days)", "pain_present:No pain"],
                        condition: "Gradual vision loss",
                        management: "Routine ophthalmology assessment"
                    }
                }
            },
            "Raised IOP": {
                description: "Management pathway for elevated intraocular pressure",
                pathways: ["Acute symptomatic", "Chronic asymptomatic", "Steroid-induced"],
                redFlags: [
                    "IOP >35 mmHg",
                    "Corneal edema",
                    "Fixed dilated pupil",
                    "Severe pain with nausea",
                    "Visual halos"
                ],
                questions: [
                    {
                        id: "iop_level",
                        text: "What is the IOP measurement?",
                        subtitle: "If known - otherwise select symptoms",
                        options: ["<21 mmHg", "21-30 mmHg", "31-40 mmHg", ">40 mmHg", "Not measured but symptomatic"],
                        clinicalNote: "IOP >30 with symptoms requires urgent management"
                    },
                    {
                        id: "symptoms",
                        text: "Are there associated symptoms?",
                        options: ["No symptoms", "Mild headache", "Severe pain + nausea", "Halos around lights", "Red eye"],
                        clinicalNote: "Symptoms suggest acute angle closure requiring emergency treatment"
                    },
                    {
                        id: "pupil_status",
                        text: "Check pupil in affected eye",
                        options: ["Normal reactive", "Sluggish", "Mid-dilated and fixed", "Not assessed"],
                        clinicalNote: "Fixed mid-dilated pupil is pathognomonic for acute angle closure"
                    },
                    {
                        id: "medication_history",
                        text: "Current medications?",
                        subtitle: "Particularly eye drops",
                        options: ["No eye drops", "Steroid eye drops", "Glaucoma drops", "Recent dilating drops"],
                        clinicalNote: "Steroid response can cause significant IOP elevation"
                    },
                    {
                        id: "risk_assessment",
                        text: "Risk factors present?",
                        options: ["Hypermetropia", "Family history glaucoma", "Asian ethnicity", "Shallow anterior chamber", "None identified"],
                        clinicalNote: "Multiple risk factors increase chance of angle closure"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["symptoms:Severe pain + nausea", "pupil_status:Mid-dilated and fixed"],
                        condition: "Acute angle closure glaucoma",
                        management: "IMMEDIATE referral, start acetazolamide 500mg, topical therapy"
                    },
                    urgent: {
                        criteria: ["iop_level:>40 mmHg", "symptoms:Halos around lights"],
                        condition: "Significantly raised IOP",
                        management: "Urgent ophthalmology within 24 hours, start topical therapy"
                    },
                    routine: {
                        criteria: ["symptoms:No symptoms", "iop_level:21-30 mmHg"],
                        condition: "Ocular hypertension",
                        management: "Routine glaucoma assessment"
                    }
                }
            },
            "Eyelid Problems": {
                description: "Assessment for lid malposition, infection, and malignancy",
                pathways: ["Infectious", "Mechanical", "Neoplastic", "Inflammatory"],
                redFlags: [
                    "Orbital signs (proptosis, restricted movements)",
                    "Systemically unwell with lid swelling",
                    "Loss of eyelashes",
                    "Ulcerating lesion",
                    "Rapid growth"
                ],
                questions: [
                    {
                        id: "problem_type",
                        text: "What is the primary lid problem?",
                        options: ["Swelling", "Malposition", "Lump/lesion", "Redness/inflammation"],
                        clinicalNote: "Different pathways for infectious vs mechanical problems"
                    },
                    {
                        id: "swelling_extent",
                        text: "If swelling, what is the extent?",
                        options: ["Localized (stye/chalazion)", "Whole lid", "Lid + cheek", "Not applicable"],
                        clinicalNote: "Extension beyond lid suggests orbital cellulitis"
                    },
                    {
                        id: "systemic_features",
                        text: "Any systemic features?",
                        options: ["None", "Mild malaise", "Fever", "Systemically unwell"],
                        clinicalNote: "Systemic features with lid swelling require admission"
                    },
                    {
                        id: "eye_movement",
                        text: "Are eye movements normal?",
                        options: ["Normal", "Slightly restricted", "Significantly restricted", "Not tested"],
                        clinicalNote: "Restricted movements indicate orbital involvement"
                    },
                    {
                        id: "lesion_features",
                        text: "If lesion present, describe features",
                        options: ["Smooth, mobile", "Irregular edges", "Ulcerated", "Loss of lashes", "Not applicable"],
                        clinicalNote: "Irregular/ulcerated lesions need urgent biopsy"
                    },
                    {
                        id: "duration",
                        text: "How long has problem been present?",
                        options: ["<1 week", "1-4 weeks", "1-3 months", ">3 months"],
                        clinicalNote: "Chronic lesions more likely benign but need assessment"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["systemic_features:Systemically unwell", "eye_movement:Significantly restricted"],
                        condition: "Orbital cellulitis",
                        management: "ADMIT immediately for IV antibiotics"
                    },
                    urgent: {
                        criteria: ["lesion_features:Ulcerated", "lesion_features:Loss of lashes"],
                        condition: "Suspected malignancy",
                        management: "Urgent oculoplastics referral within 2 weeks"
                    },
                    routine: {
                        criteria: ["problem_type:Lump/lesion", "systemic_features:None"],
                        condition: "Benign lid lesion likely",
                        management: "Routine oculoplastics referral"
                    }
                }
            },
            "Watery Eyes": {
                description: "Evaluation of epiphora - distinguishing reflex from obstructive causes",
                pathways: ["Reflex tearing", "Lacrimal obstruction", "Lid malposition"],
                redFlags: [
                    "Associated with lid swelling",
                    "Bloody tears",
                    "Recurrent infections",
                    "Facial nerve palsy"
                ],
                questions: [
                    {
                        id: "associated_symptoms",
                        text: "Are there other eye symptoms?",
                        options: ["No - just watering", "Irritation/grittiness", "Redness", "Discharge"],
                        clinicalNote: "Associated symptoms suggest reflex tearing from ocular surface disease"
                    },
                    {
                        id: "laterality",
                        text: "Which eye(s) affected?",
                        options: ["One eye", "Both eyes equally", "Both but one worse"],
                        clinicalNote: "Unilateral suggests obstruction; bilateral suggests reflex cause"
                    },
                    {
                        id: "timing",
                        text: "When is watering worst?",
                        options: ["Constant", "Outdoors/wind", "Reading/computer", "Morning only"],
                        clinicalNote: "Environmental triggers suggest reflex tearing"
                    },
                    {
                        id: "lid_position",
                        text: "Are the eyelids in normal position?",
                        options: ["Yes", "Lower lid turning out", "Lower lid turning in", "Facial weakness"],
                        clinicalNote: "Lid malposition prevents proper tear drainage"
                    },
                    {
                        id: "previous_episodes",
                        text: "Any history of lid infections?",
                        options: ["No", "Occasional styes", "Recurrent infections", "Dacryocystitis"],
                        clinicalNote: "Recurrent infections suggest nasolacrimal obstruction"
                    }
                ],
                recommendations: {
                    urgent: {
                        criteria: ["previous_episodes:Dacryocystitis", "associated_symptoms:Discharge"],
                        condition: "Acute dacryocystitis",
                        management: "Oral antibiotics, warm compresses, urgent lacrimal referral"
                    },
                    routine: {
                        criteria: ["laterality:One eye", "timing:Constant"],
                        condition: "Likely nasolacrimal obstruction",
                        management: "Routine lacrimal clinic referral"
                    }
                }
            },
            "Pediatric Eye Problems": {
                description: "Age-appropriate assessment for children's eye conditions",
                pathways: ["Infant (<1yr)", "Toddler (1-3yr)", "School age (4-10yr)"],
                redFlags: [
                    "White pupil (leukocoria)",
                    "Cloudy cornea",
                    "Nystagmus",
                    "Not fixing/following by 3 months",
                    "Asymmetric red reflex"
                ],
                questions: [
                    {
                        id: "age_group",
                        text: "What is the child's age?",
                        options: ["0-6 months", "6-12 months", "1-3 years", "3-8 years", ">8 years"],
                        clinicalNote: "Age determines urgency and referral pathway"
                    },
                    {
                        id: "presenting_problem",
                        text: "What is the main concern?",
                        options: ["Squint/misalignment", "Red/sticky eye", "Poor vision", "Abnormal appearance", "Watery eye"],
                        clinicalNote: "Different conditions have age-specific implications"
                    },
                    {
                        id: "red_reflex",
                        text: "Is red reflex normal?",
                        subtitle: "If checked",
                        options: ["Normal both eyes", "Absent/white", "Asymmetric", "Not checked"],
                        clinicalNote: "Abnormal red reflex requires URGENT referral"
                    },
                    {
                        id: "onset_timing",
                        text: "When was problem first noticed?",
                        options: ["Since birth", "Recent weeks", "Recent months", "Intermittent"],
                        clinicalNote: "Congenital problems may need earlier intervention"
                    },
                    {
                        id: "development",
                        text: "Are developmental milestones normal?",
                        options: ["Yes", "Delayed", "Regression", "Not sure"],
                        clinicalNote: "Developmental issues may indicate syndromic conditions"
                    },
                    {
                        id: "family_history",
                        text: "Relevant family history?",
                        options: ["None", "Squint", "Lazy eye", "Childhood cataracts", "Retinoblastoma"],
                        clinicalNote: "Family history affects urgency and screening needs"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["red_reflex:Absent/white"],
                        condition: "Leukocoria - ?retinoblastoma",
                        management: "URGENT pediatric ophthalmology within 2 weeks"
                    },
                    urgent: {
                        criteria: ["age_group:0-6 months", "presenting_problem:Squint/misalignment"],
                        condition: "Infantile esotropia",
                        management: "Pediatric ophthalmology within 4-6 weeks"
                    },
                    routine: {
                        criteria: ["presenting_problem:Watery eye", "onset_timing:Since birth"],
                        condition: "Congenital nasolacrimal duct obstruction",
                        management: "Conservative management, routine referral if persists >12 months"
                    }
                }
            },
            "Diplopia": {
                description: "Double vision assessment - distinguishing neurological from mechanical causes",
                pathways: ["Monocular", "Binocular", "Variable"],
                redFlags: [
                    "Pupil involvement (CN III)",
                    "Multiple cranial nerves",
                    "Progressive symptoms",
                    "Age >50 with acute onset",
                    "Associated neurological signs"
                ],
                questions: [
                    {
                        id: "type",
                        text: "Is diplopia monocular or binocular?",
                        subtitle: "Does it resolve when covering one eye?",
                        options: ["Resolves with one eye covered (binocular)", "Persists with one eye (monocular)", "Variable", "Unsure"],
                        clinicalNote: "Monocular diplopia is usually refractive; binocular suggests muscle/nerve pathology"
                    },
                    {
                        id: "onset",
                        text: "How did symptoms begin?",
                        options: ["Sudden onset", "Gradual over days", "Progressive over weeks", "Long-standing"],
                        clinicalNote: "Sudden onset in older patients needs urgent assessment for stroke"
                    },
                    {
                        id: "pattern",
                        text: "When is diplopia worst?",
                        options: ["Constant", "Distance only", "Near only", "Varies through day", "Certain directions"],
                        clinicalNote: "Variable symptoms suggest myasthenia gravis"
                    },
                    {
                        id: "associated_features",
                        text: "Associated symptoms?",
                        options: ["None", "Headache", "Ptosis", "Facial weakness", "Pupil abnormality"],
                        clinicalNote: "Multiple features suggest serious neurological pathology"
                    },
                    {
                        id: "risk_factors",
                        text: "Relevant history?",
                        options: ["None", "Diabetes", "Hypertension", "Recent trauma", "Thyroid disease"],
                        clinicalNote: "Vascular risk factors common in isolated CN VI palsy"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["associated_features:Pupil abnormality", "onset:Sudden onset"],
                        condition: "Third nerve palsy with pupil involvement",
                        management: "IMMEDIATE neuroimaging - ?aneurysm"
                    },
                    urgent: {
                        criteria: ["type:Resolves with one eye covered (binocular)", "onset:Sudden onset"],
                        condition: "Acute cranial nerve palsy",
                        management: "Urgent neuro-ophthalmology assessment"
                    },
                    routine: {
                        criteria: ["type:Persists with one eye (monocular)"],
                        condition: "Monocular diplopia",
                        management: "Refraction and routine ophthalmology"
                    }
                }
            },
            "Headaches with Visual Symptoms": {
                description: "Differentiating primary headaches from sight/life-threatening causes",
                pathways: ["Migraine", "Raised ICP", "Vascular", "Ocular"],
                redFlags: [
                    "Papilledema",
                    "New headache pattern >50 years",
                    "Worse on waking/valsalva",
                    "Progressive visual loss",
                    "Neurological signs"
                ],
                questions: [
                    {
                        id: "visual_symptoms",
                        text: "What visual symptoms occur?",
                        options: ["Zigzag lines/fortification", "Transient vision loss", "Persistent blur", "Double vision", "Visual field defect"],
                        clinicalNote: "Classic migraine has positive phenomena; concerning if negative symptoms"
                    },
                    {
                        id: "headache_pattern",
                        text: "Describe headache pattern",
                        options: ["Classic migraine", "Worse on waking", "Sudden severe", "Progressive worsening", "With eye movement"],
                        clinicalNote: "Morning headaches and progression suggest raised ICP"
                    },
                    {
                        id: "fundoscopy",
                        text: "Fundoscopy findings?",
                        subtitle: "If examined",
                        options: ["Normal", "Disc swelling", "Disc pallor", "Not examined"],
                        clinicalNote: "Papilledema requires URGENT investigation"
                    },
                    {
                        id: "age_symptoms",
                        text: "Age and symptom duration?",
                        options: ["<50 years, familiar pattern", ">50 years, new pattern", "Any age, progressive", "Any age, sudden onset"],
                        clinicalNote: "New headaches after 50 need investigation for GCA/masses"
                    },
                    {
                        id: "associated_features",
                        text: "Other features present?",
                        options: ["Nausea only", "Jaw claudication", "Scalp tenderness", "Red painful eye", "None"],
                        clinicalNote: "GCA features require immediate treatment"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["fundoscopy:Disc swelling", "headache_pattern:Worse on waking"],
                        condition: "Papilledema - raised ICP",
                        management: "URGENT medical admission for imaging"
                    },
                    urgent: {
                        criteria: ["associated_features:Jaw claudication", "age_symptoms:>50 years, new pattern"],
                        condition: "Giant cell arteritis",
                        management: "Immediate prednisolone 60-80mg, urgent ESR/CRP"
                    },
                    routine: {
                        criteria: ["visual_symptoms:Zigzag lines/fortification", "age_symptoms:<50 years, familiar pattern"],
                        condition: "Migraine with aura",
                        management: "GP management, prophylaxis if frequent"
                    }
                }
            },
            "Corneal Problems": {
                description: "Assessment of corneal pathology including trauma, infection, and dystrophies",
                pathways: ["Traumatic", "Infectious", "Inflammatory", "Degenerative"],
                redFlags: [
                    "Contact lens wearer with pain",
                    "Penetrating injury suspicion",
                    "Dendritic ulcer pattern",
                    "Central corneal involvement",
                    "Hypopyon"
                ],
                questions: [
                    {
                        id: "precipitating_event",
                        text: "Was there a precipitating event?",
                        options: ["Trauma/injury", "Foreign body", "Chemical exposure", "No specific event"],
                        clinicalNote: "Chemical injuries need immediate irrigation before assessment"
                    },
                    {
                        id: "contact_lens_user",
                        text: "Does patient wear contact lenses?",
                        options: ["Yes - current user", "Yes - but not recently", "No", "Overnight wear"],
                        clinicalNote: "Contact lens keratitis can progress rapidly and needs different treatment"
                    },
                    {
                        id: "pain_level",
                        text: "Severity of pain?",
                        options: ["No pain", "Mild discomfort", "Moderate pain", "Severe pain"],
                        clinicalNote: "Severe pain with contact lens use suggests microbial keratitis"
                    },
                    {
                        id: "vision_impact",
                        text: "Is vision affected?",
                        options: ["No change", "Slight blur", "Significant reduction", "Can't see details"],
                        clinicalNote: "Vision loss suggests central corneal involvement"
                    },
                    {
                        id: "fluorescein_pattern",
                        text: "Fluorescein staining pattern?",
                        subtitle: "If available",
                        options: ["No uptake", "Linear abrasion", "Punctate staining", "Dendritic pattern", "Large epithelial defect", "Not tested"],
                        clinicalNote: "Dendritic = HSV keratitis; Geographic = healing/treated HSV"
                    },
                    {
                        id: "associated_features",
                        text: "Other features present?",
                        options: ["White infiltrate", "Hypopyon", "Corneal thinning", "None visible"],
                        clinicalNote: "Infiltrates and hypopyon indicate severe infection"
                    }
                ],
                recommendations: {
                    emergency: {
                        criteria: ["contact_lens_user:Yes - current user", "fluorescein_pattern:Large epithelial defect"],
                        condition: "Contact lens keratitis",
                        management: "Stop CL wear immediately, same-day referral, scrape before antibiotics"
                    },
                    urgent: {
                        criteria: ["fluorescein_pattern:Dendritic pattern"],
                        condition: "Herpetic keratitis",
                        management: "Same-day ophthalmology, start aciclovir 3% 5x daily"
                    },
                    routine: {
                        criteria: ["fluorescein_pattern:Linear abrasion", "contact_lens_user:No"],
                        condition: "Simple corneal abrasion",
                        management: "Chloramphenicol QDS 5-7 days, review if not healing"
                    }
                }
            }
        };

        // Enhanced clinical schema from second file for ophthalmology pathways
        const ophthalmologySchema = {
            "Red Eye": {
                triageLogic: {
                    emergency: [
                        {
                            criteria: ["recent_surgery:Yes", "vision_affected:Significant vision loss"],
                            condition: "Suspected endophthalmitis",
                            management: ["URGENT ophthalmology referral", "Document visual acuity", "No topical treatment"]
                        }
                    ],
                    urgent: [
                        {
                            criteria: ["pain_severity:Severe pain with photophobia", "pupil_size:Smaller/same as other eye"],
                            condition: "Anterior uveitis",
                            management: ["Same-day ophthalmology referral", "Check for systemic associations", "No topical steroids"]
                        }
                    ],
                    routine: [
                        {
                            criteria: ["laterality:Bilateral", "discharge:Mucopurulent discharge"],
                            condition: "Bacterial conjunctivitis",
                            management: ["Chloramphenicol 1% QDS 7 days", "Hygiene advice", "Review if no improvement in 48-72h"]
                        }
                    ]
                },
                semiUrgent: [
                    {
                        criteria: ["vision_affected:Mild blur"],
                        condition: "Visual disturbance requiring assessment",
                        management: ["Optometry review within 48-72 hours", "Document visual acuity", "Monitor symptoms"]
                    }
                ],
                defaultRules: {
                    visionBased: {
                        "vision_affected:Significant vision loss": {
                            condition: "Unexplained vision loss requiring urgent assessment",
                            urgency: "emergency",
                            management: ["Same-day ophthalmology assessment", "Document visual acuity", "Rule out serious pathology"]
                        }
                    }
                }
            },
            "Flashes & Floaters": {
                triageLogic: {
                    emergency: [
                        {
                            criteria: ["visual_field:Yes - progressive"],
                            condition: "Retinal detachment",
                            management: ["IMMEDIATE ophthalmology", "Posture if macula-on", "Surgery within 24h"]
                        }
                    ],
                    urgent: [
                        {
                            criteria: ["onset_timing:Within 24 hours", "risk_factors:High myopia (>-6D)"],
                            condition: "Acute PVD high-risk patient",
                            management: ["Urgent retinal exam <48h", "Dilated peripheral exam", "Counsel on RD symptoms"]
                        }
                    ],
                    routine: [
                        {
                            criteria: ["onset_timing:Over 1 month ago", "visual_field:No", "vision_quality:Normal"],
                            condition: "Chronic floaters",
                            management: ["Routine ophthalmology", "Reassurance if PVD confirmed", "Annual screening if myopic"]
                        }
                    ]
                },
                semiUrgent: [
                    {
                        criteria: ["onset_timing:Within 1 month", "risk_factors:Previous retinal problems"],
                        condition: "Recent symptoms in high-risk patient",
                        management: ["Retinal exam within 2 weeks", "Thorough peripheral examination", "Document findings"]
                    }
                ],
                defaultRules: {
                    fieldBased: {
                        "visual_field:Yes - progressive": {
                            condition: "Progressive field defect - retinal detachment until proven otherwise",
                            urgency: "emergency",
                            management: ["IMMEDIATE ophthalmology", "Keep nil by mouth", "Prepare for surgery"]
                        }
                    },
                    onsetBased: {
                        "onset_timing:Within 24 hours": {
                            condition: "Acute vitreoretinal symptoms",
                            urgency: "urgent",
                            management: ["Dilated exam within 48h", "Higher risk period", "Clear safety-netting"]
                        }
                    }
                }
            },
            "Sudden Vision Loss": {
                triageLogic: {
                    emergency: [
                        {
                            criteria: ["gca_symptoms:Jaw claudication", "laterality:One eye (monocular)"],
                            condition: "Giant cell arteritis",
                            management: ["START prednisolone 60-80mg IMMEDIATELY", "Urgent ESR/CRP", "Temporal artery biopsy", "Protect fellow eye"]
                        },
                        {
                            criteria: ["onset_pattern:Sudden (seconds)", "visual_pattern:Complete blackout", "pain_present:No pain"],
                            condition: "Central retinal artery occlusion",
                            management: ["IMMEDIATE ophthalmology", "Ocular massage", "Lower IOP", "Consider thrombolysis <4.5h"]
                        }
                    ],
                    urgent: [
                        {
                            criteria: ["onset_pattern:Rapid (minutes)", "visual_pattern:Central scotoma"],
                            condition: "Central retinal vein occlusion",
                            management: ["Same-day ophthalmology", "Check IOP", "Cardiovascular risk factors"]
                        }
                    ],
                    routine: [
                        {
                            criteria: ["onset_pattern:Progressive (days)", "pain_present:No pain"],
                            condition: "Gradual vision loss",
                            management: ["Ophthalmology within 1 week", "Check for cataract", "Macular assessment"]
                        }
                    ]
                },
                defaultRules: {
                    gcaBased: {
                        "gca_symptoms:Jaw claudication": {
                            condition: "Giant cell arteritis until proven otherwise",
                            urgency: "emergency",
                            management: ["Immediate prednisolone 60-80mg", "Do not delay for tests", "Urgent rheumatology"]
                        }
                    },
                    patternBased: {
                        "visual_pattern:Complete blackout": {
                            condition: "Total vision loss - vascular likely",
                            urgency: "emergency",
                            management: ["IMMEDIATE assessment", "Consider CRAO/CRVO", "Time-critical intervention"]
                        }
                    }
                }
            },
            "Raised IOP": {
                triageLogic: {
                    emergency: [
                        {
                            criteria: ["symptoms:Severe pain + nausea", "pupil_status:Mid-dilated and fixed"],
                            condition: "Acute angle closure glaucoma",
                            management: ["IMMEDIATE referral", "IV acetazolamide", "Topical IOP lowering", "Analgesia/antiemetics"]
                        }
                    ],
                    urgent: [
                        {
                            criteria: ["iop_level:31-40 mmHg", "symptoms:No symptoms"],
                            condition: "Ocular hypertension",
                            management: ["Referral within 1 week", "Repeat IOP check", "Optic disc assessment"]
                        }
                    ],
                    routine: [
                        {
                            criteria: ["iop_level:21-30 mmHg", "symptoms:No symptoms"],
                            condition: "Borderline IOP",
                            management: ["Glaucoma screening service", "Annual monitoring", "Risk factor modification"]
                        }
                    ]
                },
                defaultRules: {
                    iopBased: {
                        "iop_level:>40 mmHg": {
                            condition: "Severe ocular hypertension",
                            urgency: "emergency",
                            management: ["Emergency IOP reduction", "IV/oral acetazolamide", "Multiple topical agents"]
                        }
                    }
                }
            },
            "Eyelid Problems": {
                triageLogic: {
                    emergency: [
                        {
                            criteria: ["swelling_extent:Lid + cheek", "systemic_features:Systemically unwell", "eye_movement:Significantly restricted"],
                            condition: "Orbital cellulitis",
                            management: ["ADMIT immediately", "IV antibiotics", "CT scan", "ENT/ophthalmology review"]
                        }
                    ],
                    urgent: [
                        {
                            criteria: ["lesion_features:Ulcerated", "lesion_features:Loss of lashes"],
                            condition: "Suspected malignancy",
                            management: ["Urgent oculoplastics <2 weeks", "Photograph lesion", "No treatment until biopsy"]
                        }
                    ],
                    routine: [
                        {
                            criteria: ["problem_type:Malposition", "duration:>3 months"],
                            condition: "Ectropion/Entropion",
                            management: ["Routine oculoplastics", "Lubricants", "Tape if needed"]
                        }
                    ]
                },
                defaultRules: {
                    swellingBased: {
                        "swelling_extent:Lid + cheek": {
                            condition: "Spreading cellulitis",
                            urgency: "emergency",
                            management: ["Admit for IV antibiotics", "CT scan to exclude orbital involvement", "Mark extent of erythema"]
                        }
                    }
                }
            },
            "Watery Eyes": {
                triageLogic: {
                    urgent: [
                        {
                            criteria: ["previous_episodes:Dacryocystitis", "associated_symptoms:Discharge"],
                            condition: "Acute dacryocystitis",
                            management: ["Oral antibiotics", "Warm compresses", "ENT/oculoplastics referral"]
                        }
                    ],
                    routine: [
                        {
                            criteria: ["lid_position:Lower lid turning out"],
                            condition: "Ectropion",
                            management: ["Lubricants", "Taping at night", "Oculoplastics referral"]
                        }
                    ]
                },
                defaultRules: {
                    symptomBased: {
                        "associated_symptoms:Discharge": {
                            condition: "Infective dacryocystitis",
                            urgency: "urgent",
                            management: ["Oral antibiotics", "Warm compresses", "Consider DCR after acute phase"]
                        }
                    }
                }
            },
            "Pediatric Eye Problems": {
                triageLogic: {
                    emergency: [
                        {
                            criteria: ["red_reflex:Absent/white"],
                            condition: "Leukocoria - ?retinoblastoma",
                            management: ["URGENT pediatric ophthalmology", "Within 2 weeks maximum", "Photograph if possible"]
                        }
                    ],
                    urgent: [
                        {
                            criteria: ["presenting_problem:Squint/misalignment", "age_group:0-6 months"],
                            condition: "Infantile esotropia",
                            management: ["Pediatric ophthalmology", "Within 4-6 weeks", "Early surgery may be needed"]
                        }
                    ],
                    routine: [
                        {
                            criteria: ["presenting_problem:Squint/misalignment", "age_group:3-8 years"],
                            condition: "Childhood squint",
                            management: ["Orthoptic assessment", "Check vision both eyes", "Glasses if needed"]
                        }
                    ]
                },
                defaultRules: {
                    reflexBased: {
                        "red_reflex:Absent/white": {
                            condition: "Leukocoria - urgent investigation needed",
                            urgency: "emergency",
                            management: ["URGENT pediatric ophthalmology within 2 weeks", "Rule out retinoblastoma", "Full examination under anesthesia"]
                        }
                    }
                }
            },
            "Diplopia": {
                triageLogic: {
                    emergency: [
                        {
                            criteria: ["associated_features:Pupil abnormality", "onset:Sudden onset"],
                            condition: "CN III palsy with pupil involvement",
                            management: ["IMMEDIATE neurology", "?Aneurysm", "Urgent neuroimaging"]
                        }
                    ],
                    urgent: [
                        {
                            criteria: ["type:Resolves with one eye covered (binocular)", "onset:Sudden onset", "risk_factors:None"],
                            condition: "Isolated cranial nerve palsy",
                            management: ["Neuro-ophthalmology <1 week", "Consider imaging", "Exclude GCA if >50"]
                        }
                    ],
                    routine: [
                        {
                            criteria: ["type:Persists with one eye (monocular)"],
                            condition: "Monocular diplopia",
                            management: ["Refraction", "Check for cataract", "Routine ophthalmology"]
                        }
                    ]
                },
                defaultRules: {
                    typeBased: {
                        "type:Resolves with one eye covered (binocular)": {
                            condition: "Binocular diplopia - neurological cause",
                            urgency: "urgent",
                            management: ["Neuro-ophthalmology assessment", "Consider MRI", "Check for systemic causes"]
                        }
                    }
                }
            },
            "Headaches with Visual Symptoms": {
                triageLogic: {
                    emergency: [
                        {
                            criteria: ["fundoscopy:Disc swelling", "headache_pattern:Worse on waking"],
                            condition: "Papilledema - raised ICP",
                            management: ["URGENT medical admission", "CT/MRI brain", "Neurology review", "LP if safe"]
                        }
                    ],
                    urgent: [
                        {
                            criteria: ["visual_symptoms:Double vision", "headache_pattern:Progressive worsening"],
                            condition: "Compressive lesion",
                            management: ["Urgent neuroimaging", "Neurology referral", "Document progression"]
                        }
                    ],
                    routine: [
                        {
                            criteria: ["visual_symptoms:Zigzag lines/fortification", "age_symptoms:<50 years, familiar pattern"],
                            condition: "Migraine with aura",
                            management: ["Migraine diary", "Trigger avoidance", "Prophylaxis if frequent", "GP management"]
                        }
                    ]
                },
                defaultRules: {
                    fundoscopyBased: {
                        "fundoscopy:Disc swelling": {
                            condition: "Papilledema - raised ICP",
                            urgency: "emergency",
                            management: ["URGENT medical admission", "Neuroimaging", "LP if safe", "Neurology consultation"]
                        }
                    }
                }
            },
            "Corneal Problems": {
                triageLogic: {
                    emergency: [
                        {
                            criteria: ["precipitating_event:Chemical exposure"],
                            condition: "Chemical burn",
                            management: ["IMMEDIATE irrigation", "Check pH", "Continue until pH 7.0", "Then urgent ophthalmology"]
                        }
                    ],
                    urgent: [
                        {
                            criteria: ["fluorescein_pattern:Dendritic pattern"],
                            condition: "Herpetic keratitis",
                            management: ["Same-day ophthalmology", "Antiviral therapy", "NO steroids without supervision"]
                        }
                    ],
                    routine: [
                        {
                            criteria: ["fluorescein_pattern:Linear abrasion", "contact_lens_user:No"],
                            condition: "Simple corneal abrasion",
                            management: ["Chloramphenicol QDS", "Oral analgesia", "Review 24-48h if not improving"]
                        }
                    ]
                },
                defaultRules: {
                    eventBased: {
                        "precipitating_event:Chemical exposure": {
                            condition: "Chemical injury",
                            urgency: "emergency",
                            management: ["IMMEDIATE irrigation for 30 minutes", "Check pH", "Continue until neutral", "Then urgent ophthalmology"]
                        }
                    }
                }
            }
        };

        // Include all the supporting data structures from both files
        const severityScoring = {
            "Red Eye": {
                "vision_affected": { "Normal vision": 0, "Mild blur": 2, "Significant vision loss": 5 },
                "pain_severity": { "No pain": 0, "Mild discomfort": 1, "Severe pain with photophobia": 4 },
                "recent_surgery": { "Yes": 5, "No": 0 },
                "contact_lens": { "Yes": 3, "No": 0 },
                "discharge": { "No discharge": 0, "Watery discharge": 1, "Mucopurulent discharge": 2 },
                "pupil_size": { "Smaller/same as other eye": 1, "Larger than other eye": 4, "Fixed and dilated": 5 },
                "corneal_staining": { "No staining": 0, "Punctate staining": 2, "Epithelial defect": 4, "Dendritic pattern": 5, "Not tested": 1 }
            },
            "Flashes & Floaters": {
                "onset_timing": { "Within 24 hours": 5, "Within 1 week": 3, "Within 1 month": 2, "Over 1 month ago": 1 },
                "floater_increase": { "Yes - shower of floaters": 5, "Yes - few new floaters": 3, "No change": 1, "First time floaters": 2 },
                "visual_field": { "Yes - progressive": 5, "Yes - stable": 3, "No": 0 },
                "flash_pattern": { "Arc-like flashes in periphery": 4, "Central sparkles": 2, "Zigzag patterns": 2, "No flashes": 0 },
                "risk_factors": { 
                    "High myopia (>-6D)": 3, 
                    "Previous retinal problems": 4, 
                    "Recent eye surgery": 3, 
                    "Family history RD": 2, 
                    "None": 0 
                },
                "vision_quality": { "Normal": 0, "Slightly blurred": 2, "Significantly reduced": 5 }
            },
            "Sudden Vision Loss": {
                "laterality": { "One eye (monocular)": 3, "Both eyes (binocular)": 4, "Unsure": 2 },
                "onset_pattern": { "Sudden (seconds)": 5, "Rapid (minutes)": 4, "Gradual (hours)": 2, "Progressive (days)": 1 },
                "pain_present": { "No pain": 1, "Mild discomfort": 2, "Severe pain": 4, "Pain on eye movement": 3 },
                "gca_symptoms": { "Temporal headache": 5, "Jaw claudication": 5, "Scalp tenderness": 4, "None": 0, "Multiple symptoms": 5 },
                "visual_pattern": { "Complete blackout": 5, "Central scotoma": 3, "Altitudinal defect": 4, "Curtain-like": 4, "Patchy loss": 2 },
                "duration": { "Yes - persistent": 3, "<5 minutes": 2, "5-30 minutes": 1, ">30 minutes": 2, "Recurring episodes": 3 }
            },
            "Raised IOP": {
                "iop_level": { "<21 mmHg": 0, "21-30 mmHg": 2, "31-40 mmHg": 4, ">40 mmHg": 5, "Not measured but symptomatic": 3 },
                "symptoms": { "No symptoms": 0, "Mild headache": 2, "Severe pain + nausea": 5, "Halos around lights": 3, "Red eye": 3 },
                "pupil_status": { "Normal reactive": 0, "Sluggish": 3, "Mid-dilated and fixed": 5, "Not assessed": 1 },
                "medication_history": { "No eye drops": 0, "Steroid eye drops": 3, "Glaucoma drops": 1, "Recent dilating drops": 2 },
                "risk_assessment": { "Hypermetropia": 2, "Family history glaucoma": 2, "Asian ethnicity": 2, "Shallow anterior chamber": 3, "None identified": 0 }
            },
            "Eyelid Problems": {
                "problem_type": { "Swelling": 3, "Malposition": 1, "Lump/lesion": 3, "Redness/inflammation": 2 },
                "swelling_extent": { "Localized (stye/chalazion)": 1, "Whole lid": 3, "Lid + cheek": 5, "Not applicable": 0 },
                "systemic_features": { "None": 0, "Mild malaise": 2, "Fever": 4, "Systemically unwell": 5 },
                "eye_movement": { "Normal": 0, "Slightly restricted": 3, "Significantly restricted": 5, "Not tested": 1 },
                "lesion_features": { "Smooth, mobile": 1, "Irregular edges": 3, "Ulcerated": 5, "Loss of lashes": 5, "Not applicable": 0 },
                "duration": { "<1 week": 3, "1-4 weeks": 2, "1-3 months": 1, ">3 months": 1 }
            },
            "Watery Eyes": {
                "associated_symptoms": { "No - just watering": 1, "Irritation/grittiness": 2, "Redness": 3, "Discharge": 4 },
                "laterality": { "One eye": 3, "Both eyes equally": 1, "Both but one worse": 2 },
                "timing": { "Constant": 3, "Outdoors/wind": 1, "Reading/computer": 2, "Morning only": 1 },
                "lid_position": { "Yes": 0, "Lower lid turning out": 3, "Lower lid turning in": 3, "Facial weakness": 4 },
                "previous_episodes": { "No": 0, "Occasional styes": 1, "Recurrent infections": 3, "Dacryocystitis": 5 }
            },
            "Pediatric Eye Problems": {
                "age_group": { "0-6 months": 4, "6-12 months": 3, "1-3 years": 2, "3-8 years": 1, ">8 years": 1 },
                "presenting_problem": { "Squint/misalignment": 3, "Red/sticky eye": 2, "Poor vision": 4, "Abnormal appearance": 5, "Watery eye": 1 },
                "red_reflex": { "Normal both eyes": 0, "Absent/white": 5, "Asymmetric": 4, "Not checked": 2 },
                "onset_timing": { "Since birth": 3, "Recent weeks": 2, "Recent months": 1, "Intermittent": 1 },
                "development": { "Yes": 0, "Delayed": 3, "Regression": 4, "Not sure": 1 },
                "family_history": { "None": 0, "Squint": 2, "Lazy eye": 2, "Childhood cataracts": 4, "Retinoblastoma": 5 }
            },
            "Diplopia": {
                "type": { "Resolves with one eye covered (binocular)": 3, "Persists with one eye (monocular)": 1, "Variable": 2, "Unsure": 2 },
                "onset": { "Sudden onset": 5, "Gradual over days": 3, "Progressive over weeks": 2, "Long-standing": 1 },
                "pattern": { "Constant": 4, "Distance only": 2, "Near only": 2, "Varies through day": 3, "Certain directions": 2 },
                "associated_features": { "None": 0, "Headache": 2, "Ptosis": 4, "Facial weakness": 5, "Pupil abnormality": 5 },
                "risk_factors": { "None": 0, "Diabetes": 2, "Hypertension": 2, "Recent trauma": 3, "Thyroid disease": 2 }
            },
            "Headaches with Visual Symptoms": {
                "visual_symptoms": { "Zigzag lines/fortification": 1, "Transient vision loss": 3, "Persistent blur": 4, "Double vision": 4, "Visual field defect": 5 },
                "headache_pattern": { "Classic migraine": 1, "Worse on waking": 4, "Sudden severe": 5, "Progressive worsening": 4, "With eye movement": 3 },
                "fundoscopy": { "Normal": 0, "Disc swelling": 5, "Disc pallor": 4, "Not examined": 2 },
                "age_symptoms": { "<50 years, familiar pattern": 1, ">50 years, new pattern": 4, "Any age, progressive": 3, "Any age, sudden onset": 4 },
                "associated_features": { "Nausea only": 1, "Jaw claudication": 5, "Scalp tenderness": 5, "Red painful eye": 4, "None": 0 }
            },
            "Corneal Problems": {
                "precipitating_event": { "Trauma/injury": 3, "Foreign body": 2, "Chemical exposure": 5, "No specific event": 1 },
                "contact_lens_user": { "Yes - current user": 4, "Yes - but not recently": 2, "No": 0, "Overnight wear": 5 },
                "pain_level": { "No pain": 0, "Mild discomfort": 1, "Moderate pain": 3, "Severe pain": 5 },
                "vision_impact": { "No change": 0, "Slight blur": 2, "Significant reduction": 4, "Can't see details": 5 },
                "fluorescein_pattern": { "No uptake": 0, "Linear abrasion": 2, "Punctate staining": 2, "Dendritic pattern": 5, "Large epithelial defect": 4, "Not tested": 1 },
                "associated_features": { "White infiltrate": 4, "Hypopyon": 5, "Corneal thinning": 5, "None visible": 0 }
            }
        };

        const medicationProtocols = {
            "Red Eye": {
                "emergency": {
                    medications: ["No topical treatment before specialist review", "Oral analgesia if required"],
                    notes: "Avoid topical steroids without specialist guidance"
                },
                "urgent": {
                    medications: ["Cyclopentolate 1% BD (if anterior uveitis)", "Consider oral NSAIDs"],
                    notes: "NO steroids without specialist review"
                },
                "routine": {
                    medications: ["Chloramphenicol 1% QDS 7 days", "Preservative-free lubricants QDS"],
                    notes: "Review if no improvement in 48-72 hours"
                }
            },
            "Flashes & Floaters": {
                "emergency": {
                    medications: ["No specific medications", "Avoid aspirin pre-operatively"],
                    notes: "Surgical management likely required"
                },
                "urgent": {
                    medications: ["No routine medications needed"],
                    notes: "Treatment depends on findings"
                },
                "routine": {
                    medications: ["No medications required"],
                    notes: "Reassurance and monitoring"
                }
            },
            "Sudden Vision Loss": {
                "emergency": {
                    medications: [
                        "Prednisolone 60-80mg PO STAT (if GCA)",
                        "Aspirin 300mg PO STAT (if embolic)",
                        "Consider IV methylpred if optic neuritis"
                    ],
                    notes: "Do NOT delay steroids for tests if GCA suspected"
                },
                "urgent": {
                    medications: [
                        "Aspirin 300mg then 75mg daily",
                        "Statin if not contraindicated",
                        "Antihypertensives as needed"
                    ],
                    notes: "Full vascular risk management"
                },
                "routine": {
                    medications: [
                        "Optimize existing medications",
                        "Consider aspirin if vascular risk"
                    ],
                    notes: "Focus on risk factor modification"
                }
            },
            "Raised IOP": {
                "emergency": {
                    medications: [
                        "Acetazolamide 500mg PO STAT then 250mg QDS",
                        "Timolol 0.5% STAT",
                        "Brimonidine 0.2% STAT",
                        "Pilocarpine 2% QDS"
                    ],
                    notes: "IV acetazolamide if vomiting"
                },
                "urgent": {
                    medications: [
                        "Timolol 0.5% BD",
                        "Consider oral acetazolamide"
                    ],
                    notes: "Start treatment while awaiting review"
                },
                "routine": {
                    medications: ["Consider topical therapy based on risk"],
                    notes: "Treatment decision after full assessment"
                }
            },
            "Corneal Problems": {
                "emergency": {
                    medications: ["Intensive fortified antibiotics as per protocol"],
                    notes: "NO treatment until after corneal scrape"
                },
                "urgent": {
                    medications: [
                        "Aciclovir 3% ointment 5x daily (if HSV)",
                        "Chloramphenicol 1% QDS (if bacterial)"
                    ],
                    notes: "Stop contact lens wear immediately"
                },
                "routine": {
                    medications: ["Chloramphenicol 1% QDS 5-7 days"],
                    notes: "Simple abrasions heal quickly"
                }
            }
        };

        const safetyNettingConfig = {
            "Red Eye": {
                "emergency": [
                    "Return IMMEDIATELY if vision deteriorates",
                    "Seek urgent care if pain increases dramatically",
                    "Do not use any eye drops unless prescribed",
                    "Keep emergency eye department contact details"
                ],
                "urgent": [
                    "Return if symptoms worsen or no improvement in 24 hours",
                    "Avoid driving if vision affected",
                    "Use prescribed medications as directed",
                    "Attend all follow-up appointments"
                ],
                "routine": [
                    "Return if no improvement in 48-72 hours",
                    "Complete full course of antibiotics",
                    "Maintain good hygiene",
                    "Avoid sharing towels/pillows"
                ]
            },
            "Flashes & Floaters": {
                "emergency": [
                    "Return IMMEDIATELY if curtain/shadow develops in vision",
                    "Seek urgent care if sudden shower of new floaters",
                    "Call 999 if sudden complete vision loss",
                    "Keep mobile phone charged and accessible"
                ],
                "urgent": [
                    "Return urgently if visual field defect develops",
                    "Monitor for increasing floaters or flashes",
                    "Avoid heavy lifting/straining until reviewed",
                    "Have someone available to drive if vision deteriorates"
                ],
                "routine": [
                    "Annual dilated examination if high myope",
                    "Return if symptoms change or worsen",
                    "Maintain regular eye examinations",
                    "Report any new visual symptoms promptly"
                ]
            },
            "Sudden Vision Loss": {
                "emergency": [
                    "Take prescribed steroids EXACTLY as directed (if GCA)",
                    "Do NOT stop steroids without medical advice",
                    "Return IMMEDIATELY if vision worsens or other eye affected",
                    "Keep emergency contact numbers readily available"
                ],
                "urgent": [
                    "Monitor for vision changes in either eye",
                    "Take aspirin as prescribed (if vascular cause)",
                    "Attend all follow-up appointments",
                    "Control vascular risk factors strictly"
                ],
                "routine": [
                    "Regular monitoring of vision",
                    "Optimize cardiovascular risk factors",
                    "Report any new symptoms immediately",
                    "Maintain prescribed medications"
                ]
            },
            "Raised IOP": {
                "emergency": [
                    "Take all medications as prescribed",
                    "Return IMMEDIATELY if pain worsens",
                    "Do not stop medications without advice",
                    "Avoid pupil dilating medications"
                ],
                "urgent": [
                    "Use eye drops regularly as prescribed",
                    "Avoid medications that can raise IOP",
                    "Return if symptoms develop",
                    "Attend scheduled follow-up"
                ],
                "routine": [
                    "Regular IOP monitoring essential",
                    "Compliance with treatment important",
                    "Annual eye examinations",
                    "Report any new symptoms"
                ]
            },
            "Eyelid Problems": {
                "emergency": [
                    "Return IMMEDIATELY if eye movements worsen",
                    "Complete full course of antibiotics",
                    "Monitor temperature regularly",
                    "Seek urgent care if systemically unwell"
                ],
                "urgent": [
                    "Take antibiotics as prescribed",
                    "Apply warm compresses as directed",
                    "Mark extent of redness with pen",
                    "Return if spreading beyond marked area"
                ],
                "routine": [
                    "Continue warm compresses",
                    "Complete antibiotic course",
                    "Maintain lid hygiene",
                    "Follow-up as arranged"
                ]
            },
            "Watery Eyes": {
                "urgent": [
                    "Take antibiotics as prescribed",
                    "Apply warm compresses regularly",
                    "Return if swelling or pain increases",
                    "Maintain good hygiene"
                ],
                "routine": [
                    "Continue conservative measures",
                    "Use lubricants as needed",
                    "Protect from wind/cold",
                    "Follow-up as arranged"
                ]
            },
            "Pediatric Eye Problems": {
                "emergency": [
                    "Attend appointment without delay",
                    "Bring all previous photos of child's eyes",
                    "Do not miss appointment",
                    "Contact if any deterioration"
                ],
                "urgent": [
                    "Monitor for changes in eye alignment",
                    "Watch for vision-related behaviors",
                    "Attend all appointments",
                    "Report any new concerns"
                ],
                "routine": [
                    "Regular vision screening important",
                    "Watch for eye rubbing/closing",
                    "Ensure good lighting for tasks",
                    "Follow orthoptic advice"
                ]
            },
            "Diplopia": {
                "emergency": [
                    "Do NOT drive",
                    "Seek immediate care if symptoms worsen",
                    "Report any new neurological symptoms",
                    "Keep emergency contacts available"
                ],
                "urgent": [
                    "Avoid driving until assessed",
                    "Cover one eye if needed for safety",
                    "Report progression immediately",
                    "Attend neurology appointment"
                ],
                "routine": [
                    "Use eye patch as directed",
                    "Avoid driving if diplopia persists",
                    "Consider prisms if recommended",
                    "Regular follow-up important"
                ]
            },
            "Headaches with Visual Symptoms": {
                "emergency": [
                    "Take steroids as prescribed (if GCA)",
                    "Do not stop medications",
                    "Return if symptoms worsen",
                    "Call 999 if sudden severe headache"
                ],
                "urgent": [
                    "Keep headache diary",
                    "Take medications as prescribed",
                    "Avoid known triggers",
                    "Attend neurology follow-up"
                ],
                "routine": [
                    "Maintain headache diary",
                    "Identify and avoid triggers",
                    "Regular sleep pattern important",
                    "Consider prophylaxis if frequent"
                ]
            },
            "Corneal Problems": {
                "emergency": [
                    "STOP contact lens wear immediately",
                    "Do not resume until cleared",
                    "Use medications exactly as prescribed",
                    "Return if pain increases"
                ],
                "urgent": [
                    "No contact lens wear",
                    "Use medications as directed",
                    "Avoid rubbing eyes",
                    "Return if not improving in 24h"
                ],
                "routine": [
                    "Complete antibiotic course",
                    "Avoid contact lenses until healed",
                    "Use lubricants as needed",
                    "Follow-up if not healed in 48h"
                ]
            }
        };

        // Clinical notes templates for GOS18
        const clinicalNotesTemplates = {
            "Red Eye": {
                "emergency": (responses) => 
                    `URGENT: ${responses.laterality} red eye with ${responses.vision_affected}. 
                    ${responses.pain_severity === 'Severe pain with photophobia' ? 'Severe photophobia present. ' : ''}
                    ${responses.recent_surgery === 'Yes' ? 'POST-OPERATIVE - HIGH RISK. ' : ''}
                    ${responses.contact_lens === 'Yes' ? 'Contact lens wearer. ' : ''}
                    ${responses.discharge}. Pupil: ${responses.pupil_size}. 
                    ${responses.corneal_staining !== 'Not tested' ? `Staining: ${responses.corneal_staining}. ` : ''}
                    Requires immediate assessment to exclude sight-threatening pathology.`,
                
                "urgent": (responses) => 
                    `${responses.laterality} red eye, ${responses.pain_severity}. Vision: ${responses.vision_affected}. 
                    ${responses.discharge}. ${responses.contact_lens === 'Yes' ? 'Contact lens wearer. ' : ''}
                    Clinical features suggest inflammatory/infective cause requiring prompt treatment.`,
                
                "routine": (responses) => 
                    `${responses.laterality} red eye, likely ${responses.discharge === 'Mucopurulent discharge' ? 'bacterial conjunctivitis' : 'viral/allergic'}. 
                    Vision: ${responses.vision_affected}. Conservative management initiated.`
            },
            "Flashes & Floaters": {
                "emergency": (responses) => 
                    `URGENT: ${responses.floater_increase === 'Yes - shower of floaters' ? 'Shower of new floaters' : 'Acute symptoms'} 
                    with ${responses.flash_pattern || 'flashing lights'}. 
                    ${responses.visual_field === 'Yes - progressive' ? 'PROGRESSIVE FIELD DEFECT - ?RD. ' : ''}
                    Onset ${responses.onset_timing}. Risk factors: ${responses.risk_factors}. 
                    Vision quality: ${responses.vision_quality}.
                    Requires immediate dilated retinal examination to exclude retinal tear/detachment.`,
                
                "urgent": (responses) => 
                    `Recent onset ${responses.flash_pattern || 'flashes'} and floaters, started ${responses.onset_timing}. 
                    ${responses.risk_factors !== 'None' ? `High risk patient (${responses.risk_factors}). ` : ''}
                    Floater increase: ${responses.floater_increase}. Vision: ${responses.vision_quality}.
                    No field defect currently. Requires dilated peripheral retinal examination within 48 hours 
                    to exclude retinal tear. Patient counselled re RD symptoms.`,
                
                "routine": (responses) => 
                    `Chronic floaters ${responses.onset_timing}. No recent change. 
                    Vision ${responses.vision_quality}. No field defect. 
                    Likely benign PVD but requires confirmation with dilated examination.`
            },
            "Sudden Vision Loss": {
                "emergency": (responses) => 
                    `EMERGENCY: Sudden ${responses.laterality} vision loss (${responses.visual_pattern}). 
                    ${responses.gca_symptoms !== 'None' ? `GCA SYMPTOMS: ${responses.gca_symptoms} - STARTED HIGH-DOSE STEROIDS. ` : ''}
                    Onset ${responses.onset_pattern}. ${responses.pain_present}. 
                    ${responses.duration === 'Yes - persistent' ? 'Persistent loss.' : `Duration: ${responses.duration}.`}
                    Requires immediate assessment and treatment.`,
                
                "urgent": (responses) => 
                    `Acute ${responses.laterality} visual disturbance. ${responses.visual_pattern} pattern. 
                    Onset ${responses.onset_pattern}. ${responses.pain_present}. 
                    ${responses.duration !== 'Yes - persistent' ? `Transient episode lasting ${responses.duration}. ` : ''}
                    Requires urgent assessment for ${responses.duration === '<5 minutes' ? 'TIA/stroke risk' : 'cause'}.`,
                
                "routine": (responses) => 
                    `${responses.onset_pattern} vision loss, ${responses.laterality}. 
                    ${responses.visual_pattern} pattern. No acute features. 
                    Requires ophthalmology assessment to determine cause and optimize management.`
            },
            "Raised IOP": {
                "emergency": (responses) => 
                    `EMERGENCY: IOP ${responses.iop_level} with ${responses.symptoms}. 
                    Pupil: ${responses.pupil_status}. ${responses.medication_history}. 
                    Risk factors: ${responses.risk_assessment}. 
                    Clinical features consistent with acute angle closure requiring immediate treatment.`,
                
                "urgent": (responses) => 
                    `Raised IOP ${responses.iop_level}. Symptoms: ${responses.symptoms}. 
                    Pupil status: ${responses.pupil_status}. Current medications: ${responses.medication_history}. 
                    Requires urgent assessment and IOP management.`,
                
                "routine": (responses) => 
                    `Ocular hypertension. IOP ${responses.iop_level}, ${responses.symptoms}. 
                    Risk assessment: ${responses.risk_assessment}. 
                    Requires glaucoma risk stratification and monitoring.`
            },
            "Eyelid Problems": {
                "emergency": (responses) => 
                    `URGENT: ${responses.problem_type} with ${responses.systemic_features}. 
                    Swelling extent: ${responses.swelling_extent}. Eye movements: ${responses.eye_movement}. 
                    Duration: ${responses.duration}. 
                    Clinical features suggest orbital involvement requiring immediate admission.`,
                
                "urgent": (responses) => 
                    `Lid ${responses.problem_type}. ${responses.systemic_features}. 
                    ${responses.lesion_features !== 'Not applicable' ? `Lesion features: ${responses.lesion_features}. ` : ''}
                    Duration: ${responses.duration}. Requires urgent assessment.`,
                
                "routine": (responses) => 
                    `Lid ${responses.problem_type}, duration ${responses.duration}. 
                    No systemic features. ${responses.lesion_features !== 'Not applicable' ? `Features: ${responses.lesion_features}. ` : ''}
                    Routine oculoplastics referral indicated.`
            },
            "Watery Eyes": {
                "routine": (responses) => 
                    `${responses.laterality} epiphora. ${responses.associated_symptoms}. 
                    Timing: ${responses.timing}. Lid position: ${responses.lid_position}. 
                    Previous episodes: ${responses.previous_episodes}. 
                    ${responses.laterality === 'One eye' ? 'Likely nasolacrimal obstruction' : 'Likely reflex tearing'}.`
            },
            "Pediatric Eye Problems": {
                "emergency": (responses) => 
                    `URGENT PAEDIATRIC: Age ${responses.age_group}, presenting with ${responses.presenting_problem}. 
                    Red reflex: ${responses.red_reflex}. Onset: ${responses.onset_timing}. 
                    Development: ${responses.development}. Family history: ${responses.family_history}. 
                    Requires urgent pediatric ophthalmology assessment to exclude serious pathology.`,
                
                "urgent": (responses) => 
                    `Child age ${responses.age_group} with ${responses.presenting_problem}. 
                    Red reflex: ${responses.red_reflex}. Onset: ${responses.onset_timing}. 
                    Family history: ${responses.family_history}. Requires pediatric assessment.`,
                
                "routine": (responses) => 
                    `Pediatric referral: Age ${responses.age_group}, ${responses.presenting_problem}. 
                    Onset ${responses.onset_timing}. Development normal. 
                    Routine pediatric ophthalmology assessment recommended.`
            },
            "Diplopia": {
                "urgent": (responses) => 
                    `${responses.type} diplopia, ${responses.onset} onset. 
                    Pattern: ${responses.pattern}. Associated features: ${responses.associated_features}. 
                    Risk factors: ${responses.risk_factors}. 
                    Requires urgent neuro-ophthalmology assessment to determine cause.`,
                
                "routine": (responses) => 
                    `${responses.type} diplopia, ${responses.onset}. 
                    Pattern: ${responses.pattern}. No associated neurological features. 
                    Routine orthoptic/ophthalmology assessment indicated.`
            },
            "Headaches with Visual Symptoms": {
                "emergency": (responses) => 
                    `URGENT: Headache with ${responses.visual_symptoms}. Pattern: ${responses.headache_pattern}. 
                    Fundoscopy: ${responses.fundoscopy}. Age/symptoms: ${responses.age_symptoms}. 
                    Associated: ${responses.associated_features}. 
                    Requires immediate investigation for raised ICP/GCA.`,
                
                "routine": (responses) => 
                    `Headache with ${responses.visual_symptoms}. ${responses.headache_pattern} pattern. 
                    Fundoscopy: ${responses.fundoscopy}. ${responses.age_symptoms}. 
                    Likely primary headache disorder, routine management appropriate.`
            },
            "Corneal Problems": {
                "emergency": (responses) => 
                    `URGENT: Corneal pathology. ${responses.precipitating_event}. 
                    ${responses.contact_lens_user === 'Yes - current user' ? 'CONTACT LENS KERATITIS RISK. ' : ''}
                    Pain: ${responses.pain_level}. Vision: ${responses.vision_impact}. 
                    Staining: ${responses.fluorescein_pattern}. ${responses.associated_features}. 
                    Requires immediate ophthalmology assessment and treatment.`,
                
                "urgent": (responses) => 
                    `Corneal ${responses.precipitating_event}. ${responses.contact_lens_user}. 
                    Pain level: ${responses.pain_level}. Vision impact: ${responses.vision_impact}. 
                    Fluorescein: ${responses.fluorescein_pattern}. Requires same-day assessment.`,
                
                "routine": (responses) => 
                    `Corneal abrasion/SPK. Cause: ${responses.precipitating_event}. 
                    Minimal pain, vision preserved. Staining: ${responses.fluorescein_pattern}. 
                    Conservative management with antibiotic prophylaxis.`
            }
        };

        // Helper functions
        function getTimeframeForUrgency(urgency) {
            const timeframes = {
                'emergency': 'Immediate/Same-day',
                'urgent': 'Within 24-48 hours',
                'semi-urgent': 'Within 48-72 hours',
                'routine': 'Routine (within 4-12 weeks)'
            };
            return timeframes[urgency] || 'Within 48 hours';
        }

        function calculateSeverityScore(condition, responses) {
            let totalScore = 0;
            const scoring = severityScoring[condition];
            
            if (!scoring) return 0;
            
            Object.entries(responses).forEach(([questionId, answer]) => {
                if (scoring[questionId] && scoring[questionId][answer] !== undefined) {
                    totalScore += scoring[questionId][answer];
                }
            });
            
            return totalScore;
        }

        function calculateUrgencyByScore(totalScore, condition) {
            const thresholds = {
                "Red Eye": { emergency: 17, urgent: 9 },
                "Flashes & Floaters": { emergency: 15, urgent: 8 },
                "Sudden Vision Loss": { emergency: 15, urgent: 8 },
                "Raised IOP": { emergency: 12, urgent: 6 },
                "Eyelid Problems": { emergency: 16, urgent: 8 },
                "Watery Eyes": { emergency: 9, urgent: 5 },
                "Pediatric Eye Problems": { emergency: 15, urgent: 8 },
                "Diplopia": { emergency: 12, urgent: 6 },
                "Headaches with Visual Symptoms": { emergency: 14, urgent: 7 },
                "Corneal Problems": { emergency: 16, urgent: 8 }
            };
            
            const threshold = thresholds[condition] || { emergency: 15, urgent: 8 };
            
            if (totalScore >= threshold.emergency) return "emergency";
            if (totalScore >= threshold.urgent) return "urgent";
            return "routine";
        }

        function checkCriteria(criteria, responses) {
            return criteria.every(criterion => {
                const [questionId, expectedAnswer] = criterion.split(':');
                return responses[questionId] === expectedAnswer;
            });
        }

        function applyEnhancedDefaultRules(schema, responses, severityScore, scoreBasedUrgency) {
            let bestMatch = null;
            let highestPriority = -1;
            
            const maxScore = maxScores[selectedCondition] || 20;
            const severityPercentage = Math.round((severityScore / maxScore) * 100);
            
            const rulePriority = {
                'visionBased': 10,
                'symptomBased': 9,
                'riskBased': 8,
                'fieldBased': 10,
                'gcaBased': 10,
                'patternBased': 9,
                'onsetBased': 7,
                'painBased': 8,
                'reflexBased': 10,
                'ageBased': 6,
                'typeBased': 8,
                'featureBased': 9,
                'fundoscopyBased': 10,
                'swellingBased': 8,
                'lesionBased': 9,
                'systemicBased': 10,
                'iopBased': 9,
                'lidBased': 7,
                'lateralityBased': 6,
                'eventBased': 9,
                'contactLensBased': 9,
                'stainBased': 9,
                'durationBased': 6,
                'problemBased': 7
            };
            
            if (!schema.defaultRules) return null;
            
            for (const [category, rules] of Object.entries(schema.defaultRules)) {
                const priority = rulePriority[category] || 5;
                
                for (const [criterion, ruleData] of Object.entries(rules)) {
                    const [questionId, expectedAnswer] = criterion.split(':');
                    
                    if (responses[questionId] === expectedAnswer) {
                        if (priority > highestPriority) {
                            highestPriority = priority;
                            bestMatch = {
                                urgency: ruleData.urgency || scoreBasedUrgency || 'urgent',
                                condition: ruleData.condition,
                                reasoning: `Based on ${questionId.replace(/_/g, ' ')}: ${expectedAnswer}. ${ruleData.condition}. Severity score: ${severityScore}/${maxScore} (${severityPercentage}%).`,
                                management: ruleData.management,
                                referralTimeframe: getTimeframeForUrgency(ruleData.urgency || scoreBasedUrgency || 'urgent'),
                                severityScore: severityScore
                            };
                        }
                    }
                }
            }
            
            return bestMatch;
        }

        function getDefaultManagement(urgency, condition) {
            const defaultManagement = {
                emergency: [
                    "Immediate ophthalmology assessment required",
                    "Document all findings",
                    "Do not delay referral",
                    "Consider admission if systemic symptoms"
                ],
                urgent: [
                    "Urgent ophthalmology assessment within 24-48 hours",
                    "Document visual acuity",
                    "Safety-net advice crucial",
                    "Consider starting treatment if clear diagnosis"
                ],
                routine: [
                    "Routine ophthalmology referral",
                    "Conservative management initially",
                    "Review if symptoms worsen",
                    "Patient education important"
                ]
            };
            
            return defaultManagement[urgency] || defaultManagement.urgent;
        }

        // Generate both optometry and ophthalmology recommendations
        function generateBothRecommendations() {
            const severityScore = calculateSeverityScore(selectedCondition, responses);
            const scoreBasedUrgency = calculateUrgencyByScore(severityScore, selectedCondition);
            
            // Generate optometry recommendation
            const optometryRec = generateOptometryRecommendation(severityScore, scoreBasedUrgency);
            
            // Generate ophthalmology recommendation
            const ophthalmologyRec = generateOphthalmologyRecommendation(severityScore, scoreBasedUrgency);
            
            // Determine specific condition from responses to get MECS protocol
            const mecsCondition = determineMECSCondition(selectedCondition, responses);
            
            return {
                optometry: optometryRec,
                ophthalmology: ophthalmologyRec,
                severityScore: severityScore,
                combinedUrgency: optometryRec.urgency,
                mecsCondition: mecsCondition
            };
        }

        function determineMECSCondition(condition, responses) {
            // Determine specific condition based on responses for MECS protocol matching
            if (condition === "Red Eye") {
                if (responses.discharge === "Mucopurulent discharge") {
                    return "Bacterial conjunctivitis";
                } else if (responses.discharge === "Watery discharge") {
                    return "Viral conjunctivitis";
                } else if (responses.pain_severity === "Severe pain with photophobia") {
                    return "Anterior uveitis";
                }
            } else if (condition === "Flashes & Floaters") {
                if (responses.visual_field === "Yes - progressive") {
                    return "Retinal detachment";
                } else if (responses.floater_increase === "Yes - shower of floaters") {
                    return "Retinal tear";
                } else {
                    return "Posterior vitreous detachment";
                }
            } else if (condition === "Raised IOP") {
                if (responses.symptoms === "Severe pain + nausea") {
                    return "Acute angle closure";
                } else if (responses.iop_level === "21-30 mmHg") {
                    return "Ocular hypertension";
                }
            } else if (condition === "Eyelid Problems") {
                if (responses.problem_type === "Swelling" && responses.swelling_extent === "Localized (stye/chalazion)") {
                    return "Chalazion";
                } else if (responses.systemic_features === "None" || responses.systemic_features === "Mild malaise") {
                    return "Preseptal cellulitis";
                } else if (responses.eye_movement === "Significantly restricted") {
                    return "Orbital cellulitis";
                }
            } else if (condition === "Corneal Problems") {
                if (responses.contact_lens_user === "Yes - current user" && responses.pain_level === "Severe pain") {
                    return "Contact lens keratitis";
                } else if (responses.fluorescein_pattern === "Dendritic pattern") {
                    return "Herpetic keratitis";
                } else if (responses.fluorescein_pattern === "Linear abrasion") {
                    return "Corneal abrasion";
                } else if (responses.precipitating_event === "Foreign body") {
                    return "Corneal foreign body";
                }
            }
            
            return null;
        }

        function generateOptometryRecommendation(severityScore, scoreBasedUrgency) {
            const condition = clinicalData[selectedCondition];
            let matchFound = false;
            let recommendation = null;
            
            const maxScore = maxScores[selectedCondition] || 20;
            const severityPercentage = Math.round((severityScore / maxScore) * 100);
            
            // Check emergency criteria
            if (condition.recommendations.emergency) {
                const emergency = condition.recommendations.emergency;
                if (checkCriteria(emergency.criteria, responses)) {
                    recommendation = {
                        urgency: 'emergency',
                        condition: emergency.condition,
                        management: emergency.management,
                        reasoning: `Emergency criteria met. ${emergency.condition}. Severity score: ${severityScore}/${maxScore} (${severityPercentage}%).`
                    };
                    matchFound = true;
                }
            }
            
            // Check urgent criteria
            if (!matchFound && condition.recommendations.urgent) {
                const urgent = condition.recommendations.urgent;
                if (checkCriteria(urgent.criteria, responses)) {
                    recommendation = {
                        urgency: 'urgent',
                        condition: urgent.condition,
                        management: urgent.management,
                        reasoning: `Urgent criteria met. ${urgent.condition}. Severity score: ${severityScore}/${maxScore} (${severityPercentage}%).`
                    };
                    matchFound = true;
                }
            }
            
            // Check routine criteria
            if (!matchFound && condition.recommendations.routine) {
                const routine = condition.recommendations.routine;
                if (checkCriteria(routine.criteria, responses)) {
                    recommendation = {
                        urgency: 'routine',
                        condition: routine.condition,
                        management: routine.management,
                        reasoning: `Routine management appropriate. ${routine.condition}. Severity score: ${severityScore}/${maxScore} (${severityPercentage}%).`
                    };
                    matchFound = true;
                }
            }
            
            // Fallback
            if (!matchFound) {
                recommendation = {
                    urgency: scoreBasedUrgency,
                    condition: `${selectedCondition} requiring assessment`,
                    management: getDefaultManagement(scoreBasedUrgency, selectedCondition),
                    reasoning: `Based on severity score of ${severityScore}/${maxScore} (${severityPercentage}%). Clinical assessment recommended.`
                };
            }
            
            return recommendation;
        }

        function generateOphthalmologyRecommendation(severityScore, scoreBasedUrgency) {
            const schema = ophthalmologySchema[selectedCondition];
            
            const maxScore = maxScores[selectedCondition] || 20;
            const severityPercentage = Math.round((severityScore / maxScore) * 100);
            
            if (!schema) {
                return {
                    urgency: scoreBasedUrgency,
                    condition: `${selectedCondition} - secondary care assessment`,
                    management: ["Full ophthalmology assessment", "Determine definitive management", "Consider surgical options if needed"],
                    reasoning: `Hospital-based management for ${selectedCondition}. Severity: ${severityScore}/${maxScore} (${severityPercentage}%).`
                };
            }
            
            let matchFound = false;
            let matchType = '';
            let recommendation = null;
            
            // Check emergency criteria
            if (schema.triageLogic && schema.triageLogic.emergency) {
                for (const rule of schema.triageLogic.emergency) {
                    if (checkCriteria(rule.criteria, responses)) {
                        recommendation = {
                            urgency: 'emergency',
                            condition: rule.condition,
                            management: rule.management,
                            reasoning: `Hospital emergency pathway: ${rule.condition}. Severity score: ${severityScore}/${maxScore} (${severityPercentage}%).`
                        };
                        matchFound = true;
                        matchType = 'Emergency rule';
                        break;
                    }
                }
            }
            
            // Check urgent criteria
            if (!matchFound && schema.triageLogic && schema.triageLogic.urgent) {
                for (const rule of schema.triageLogic.urgent) {
                    if (checkCriteria(rule.criteria, responses)) {
                        recommendation = {
                            urgency: 'urgent',
                            condition: rule.condition,
                            management: rule.management,
                            reasoning: `Hospital urgent pathway: ${rule.condition}. Severity score: ${severityScore}/${maxScore} (${severityPercentage}%).`
                        };
                        matchFound = true;
                        matchType = 'Urgent rule';
                        break;
                    }
                }
            }
            
            // Check semi-urgent criteria
            if (!matchFound && schema.semiUrgent) {
                for (const rule of schema.semiUrgent) {
                    if (checkCriteria(rule.criteria, responses)) {
                        recommendation = {
                            urgency: 'semi-urgent',
                            condition: rule.condition,
                            management: rule.management,
                            reasoning: `Hospital semi-urgent pathway: ${rule.condition}. Severity score: ${severityScore}/${maxScore} (${severityPercentage}%).`
                        };
                        matchFound = true;
                        matchType = 'Semi-urgent rule';
                        break;
                    }
                }
            }
            
            // Apply enhanced default rules
            if (!matchFound) {
                const defaultMatch = applyEnhancedDefaultRules(schema, responses, severityScore, scoreBasedUrgency);
                if (defaultMatch) {
                    recommendation = defaultMatch;
                    matchFound = true;
                    matchType = 'Enhanced default rule';
                    
                    // Show enhanced indicator
                    document.getElementById('enhanced-indicator').style.display = 'flex';
                }
            }
            
            // Fallback
            if (!matchFound) {
                recommendation = {
                    urgency: scoreBasedUrgency,
                    condition: `${selectedCondition} requiring hospital assessment`,
                    management: getDefaultManagement(scoreBasedUrgency, selectedCondition),
                    reasoning: `Hospital assessment based on severity score of ${severityScore}/${maxScore} (${severityPercentage}%).`
                };
                matchType = 'Severity score fallback';
            }
            
            return recommendation;
        }

        function generateClinicalNotes(condition, urgency, responses) {
            if (clinicalNotesTemplates[condition] && clinicalNotesTemplates[condition][urgency]) {
                return clinicalNotesTemplates[condition][urgency](responses);
            }
            
            // Fallback
            let notes = `${condition} - ${urgency} referral. `;
            Object.entries(responses).forEach(([key, value]) => {
                notes += `${key.replace(/_/g, ' ')}: ${value}. `;
            });
            return notes;
        }

        function displayMECSProtocol() {
            const mecsBox = document.getElementById('mecs-protocol-box');
            const mecsContent = document.getElementById('mecs-protocol-inner');
            
            if (!recommendation || !recommendation.mecsCondition) {
                mecsBox.style.display = 'none';
                return;
            }
            
            const protocol = mecsProtocols[selectedCondition];
            if (!protocol) {
                mecsBox.style.display = 'none';
                return;
            }
            
            const conditionProtocol = protocol.conditions[recommendation.mecsCondition];
            
            if (!conditionProtocol && recommendation.combinedUrgency === 'emergency') {
                // Not MECS eligible
                mecsBox.style.display = 'block';
                mecsContent.innerHTML = `
                    <div class="mecs-protocol-subtitle">MECS Eligibility</div>
                    <div style="background-color: rgba(255, 255, 255, 0.5); padding: 0.75rem; border-radius: 0.25rem; margin-bottom: 0.75rem;">
                        <p style="color: #991b1b; font-weight: 600;">This condition EXCEEDS MECS scope</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">${protocol.overview}</p>
                        ${protocol.exclusions ? `
                            <ul class="mecs-protocol-list" style="margin-top: 0.5rem;">
                                ${protocol.exclusions.map(exc => `
                                    <li class="mecs-protocol-item">
                                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                        ${exc}
                                    </li>
                                `).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
            } else if (conditionProtocol) {
                mecsBox.style.display = 'block';
                mecsContent.innerHTML = `
                    <div class="mecs-protocol-subtitle">Condition: ${recommendation.mecsCondition}</div>
                    <p style="font-size: 0.875rem; margin-bottom: 1rem;">${protocol.overview}</p>
                    
                    <div class="mecs-criteria-box">
                        <div class="mecs-protocol-subtitle">MECS Criteria</div>
                        <ul class="mecs-protocol-list">
                            ${conditionProtocol.criteria.map(criterion => `
                                <li class="mecs-protocol-item">
                                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    ${criterion}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <div class="mecs-protocol-subtitle" style="margin-top: 1rem;">MECS Management Protocol</div>
                    <ul class="mecs-protocol-list">
                        ${conditionProtocol.management.map(step => `
                            <li class="mecs-protocol-item">
                                <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                    <polyline points="9,18 15,12 9,6"></polyline>
                                </svg>
                                ${step}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <div class="mecs-protocol-subtitle" style="margin-top: 1rem;">Documentation Required</div>
                    <ul class="mecs-protocol-list">
                        ${protocol.documentation.map(doc => `
                            <li class="mecs-protocol-item">
                                <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                ${doc}
                            </li>
                        `).join('')}
                    </ul>
                    
                    <div style="background-color: rgba(255, 255, 255, 0.5); padding: 0.75rem; border-radius: 0.25rem; margin-top: 1rem;">
                        <strong>Billing Code:</strong> ${conditionProtocol.billing}
                    </div>
                `;
            } else {
                mecsBox.style.display = 'none';
            }
        }

        function populateGOS18Form() {
            if (!recommendation) return;
            
            // Set clinical findings
            const clinicalFindingsTextarea = document.getElementById('gos18-clinical-findings');
            const clinicalNotes = generateClinicalNotes(selectedCondition, recommendation.combinedUrgency, responses);
            if (clinicalFindingsTextarea) {
                clinicalFindingsTextarea.value = clinicalNotes;
            }
            
            // Set safety netting advice
            const safetyNettingTextarea = document.getElementById('gos18-safety-netting');
            if (safetyNettingTextarea) {
                const safetyAdvice = safetyNettingConfig[selectedCondition]?.[recommendation.combinedUrgency] || [
                    "Return immediately if symptoms worsen",
                    "Seek urgent care if new symptoms develop",
                    "Attend all follow-up appointments",
                    "Contact emergency services if concerned"
                ];
                safetyNettingTextarea.value = safetyAdvice.join('\n');
            }
            
            // Check appropriate urgency box
            const urgencyCheckboxes = {
                'emergency': document.getElementById('referralOcular'),
                'urgent': document.getElementById('referralSemi'),
                'routine': document.getElementById('referralRoutine')
            };
            
            const urgencyCheckbox = urgencyCheckboxes[recommendation.combinedUrgency];
            if (urgencyCheckbox) {
                urgencyCheckbox.checked = true;
            }
            
            // Set today's date
            const referralDateInput = document.getElementById('referralDate');
            if (referralDateInput) {
                referralDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // Set appropriate subspecialty based on condition
            const subspecialtyMap = {
                "Flashes & Floaters": "supervisedMacular",
                "Sudden Vision Loss": "supervisedGeneral",
                "Red Eye": "supervisedGeneral",
                "Raised IOP": "supervisedGlaucoma",
                "Eyelid Problems": "supervisedAdnexal",
                "Watery Eyes": "supervisedAdnexal",
                "Pediatric Eye Problems": "supervisedPaed",
                "Diplopia": "supervisedSquint",
                "Headaches with Visual Symptoms": "supervisedGeneral",
                "Corneal Problems": "supervisedExternal"
            };
            
            const subspecialtyCheckbox = document.getElementsByName(subspecialtyMap[selectedCondition])[0];
            if (subspecialtyCheckbox) {
                subspecialtyCheckbox.checked = true;
            }
        }

        // UI Functions
        function displayConditions() {
            const conditionGrid = document.getElementById('condition-grid');
            conditionGrid.innerHTML = '';
            
            Object.keys(clinicalData).forEach(conditionName => {
                const condition = clinicalData[conditionName];
                const card = document.createElement('button');
                card.className = 'condition-card';
                card.onclick = () => selectCondition(conditionName);
                
                card.innerHTML = `
                    <div class="condition-header">
                        <h3 class="condition-title">${conditionName}</h3>
                        <svg class="icon" viewBox="0 0 24 24" style="opacity: 0.5;">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                    <p class="condition-description">${condition.description}</p>
                    <p class="condition-pathways">Pathways: ${condition.pathways.join(', ')}</p>
                `;
                
                conditionGrid.appendChild(card);
            });
        }

        function selectCondition(conditionName) {
            selectedCondition = conditionName;
            currentQuestionIndex = 0;
            responses = {};
            assessmentPath = [];
            questionHistory = [];
            
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('assessment-screen').classList.remove('hidden');
            document.getElementById('assessment-subtitle').textContent = `${conditionName} Assessment`;
            
            displayRedFlags();
            displayQuestion();
        }

        function displayRedFlags() {
            const redFlagsBox = document.getElementById('red-flags-box');
            const redFlagsList = document.getElementById('red-flags-list');
            const condition = clinicalData[selectedCondition];
            
            if (condition.redFlags && condition.redFlags.length > 0) {
                redFlagsBox.classList.remove('hidden');
                redFlagsList.innerHTML = '';
                
                condition.redFlags.forEach(flag => {
                    const li = document.createElement('li');
                    li.className = 'red-flag-item';
                    li.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        ${flag}
                    `;
                    redFlagsList.appendChild(li);
                });
            } else {
                redFlagsBox.classList.add('hidden');
            }
        }

        function displayQuestion() {
            const condition = clinicalData[selectedCondition];
            const questions = condition.questions;
            
            if (currentQuestionIndex >= questions.length) {
                generateRecommendation();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            
            // Update progress
            const progressText = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
            const progressPercent = Math.round((currentQuestionIndex / questions.length) * 100);
            
            document.getElementById('progress-text').textContent = progressText;
            document.getElementById('progress-percent').textContent = `${progressPercent}% Complete`;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            
            // Display question
            document.getElementById('question-title').textContent = question.text;
            
            // Display subtitle if present
            const subtitleElement = document.getElementById('question-subtitle');
            if (question.subtitle) {
                subtitleElement.textContent = question.subtitle;
                subtitleElement.classList.remove('hidden');
            } else {
                subtitleElement.classList.add('hidden');
            }
            
            // Display options
            const optionsContainer = document.getElementById('question-options');
            optionsContainer.innerHTML = '';
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options-container';
            
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option;
                button.onclick = () => selectAnswer(option);
                optionsDiv.appendChild(button);
            });
            
            optionsContainer.appendChild(optionsDiv);
            
            // Display clinical note
            const clinicalNoteElement = document.getElementById('clinical-note');
            if (question.clinicalNote) {
                clinicalNoteElement.textContent = question.clinicalNote;
                clinicalNoteElement.classList.remove('hidden');
            } else {
                clinicalNoteElement.classList.add('hidden');
            }
            
            // Update navigation
            const backButton = document.getElementById('back-button');
            backButton.disabled = questionHistory.length === 0;
        }

        function selectAnswer(answer) {
            const condition = clinicalData[selectedCondition];
            const questions = condition.questions;
            const question = questions[currentQuestionIndex];
            
            // Store response
            responses[question.id] = answer;
            assessmentPath.push({
                question: question.text,
                answer: answer
            });
            
            // Store current index in history
            questionHistory.push(currentQuestionIndex);
            
            // Move to next question
            currentQuestionIndex++;
            displayQuestion();
        }

        function previousQuestion() {
            if (questionHistory.length > 0) {
                currentQuestionIndex = questionHistory.pop();
                const condition = clinicalData[selectedCondition];
                const questionId = condition.questions[currentQuestionIndex].id;
                delete responses[questionId];
                assessmentPath.pop();
                
                displayQuestion();
            }
        }

        function generateRecommendation() {
            // Generate both recommendations
            recommendation = generateBothRecommendations();
            displayResults();
        }

        function displayResults() {
            document.getElementById('assessment-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');
            
            // Set urgency icon
            const urgencyIcon = document.getElementById('urgency-icon');
            const iconColors = {
                emergency: '#dc2626',
                urgent: '#f59e0b',
                'semi-urgent': '#3b82f6',
                routine: '#10b981'
            };
            
            urgencyIcon.style.backgroundColor = iconColors[recommendation.combinedUrgency] || '#f59e0b';
            urgencyIcon.innerHTML = `
                <svg class="icon" viewBox="0 0 24 24">
                    ${recommendation.combinedUrgency === 'emergency' ? 
                        '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' :
                        '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>'}
                </svg>
            `;
            
            // Set recommendation text
            document.getElementById('recommendation-title').textContent = 
                `${recommendation.combinedUrgency.charAt(0).toUpperCase() + recommendation.combinedUrgency.slice(1)} Referral`;
            document.getElementById('recommendation-subtitle').textContent = recommendation.optometry.condition;
            document.getElementById('reasoning-text').textContent = recommendation.optometry.reasoning;
            
            // Set severity score
            const severityScore = recommendation.severityScore || 0;
            const maxScore = maxScores[selectedCondition] || 20;
            const severityPercentage = Math.round((severityScore / maxScore) * 100);
            
            document.getElementById('severity-score').textContent = `Clinical Severity Score: ${severityScore}/${maxScore} (${severityPercentage}%)`;
            document.getElementById('severity-fill').style.width = `${severityPercentage}%`;
            
            // Display MECS protocol
            displayMECSProtocol();
            
            // Add summary to collapsed MECS section if present
            const mecsBox = document.getElementById('mecs-protocol-box');
            if (mecsBox && mecsBox.style.display !== 'none') {
                const mecsHeader = document.querySelector('.mecs-protocol-header');
                if (mecsHeader && !mecsHeader.querySelector('.accordion-summary')) {
                    const summary = document.createElement('div');
                    summary.className = 'accordion-summary';
                    if (recommendation?.mecsCondition) {
                        summary.innerHTML = `<strong>MECS ELIGIBLE</strong> â€¢ ${recommendation.mecsCondition}`;
                    } else {
                        summary.innerHTML = `<strong>NOT MECS ELIGIBLE</strong> â€¢ Exceeds scope`;
                    }
                    mecsHeader.appendChild(summary);
                }
            }
            
            // Start with optometry expanded and toggle icon rotated
            const optometryToggle = document.getElementById('optometry-toggle');
            if (optometryToggle) {
                optometryToggle.classList.add('expanded');
            }
            
            // Add summary to collapsed ophthalmology section
            const ophthalmologyHeader = document.querySelector('.ophthalmology-pathway .pathway-header');
            if (ophthalmologyHeader && !ophthalmologyHeader.querySelector('.accordion-summary')) {
                const summary = document.createElement('div');
                summary.className = 'accordion-summary';
                const urgency = recommendation?.ophthalmology?.urgency || 'Assessment';
                const condition = recommendation?.ophthalmology?.condition || 'Hospital pathway';
                summary.innerHTML = `<strong style="text-transform: uppercase;">${urgency}</strong> â€¢ ${condition}`;
                ophthalmologyHeader.appendChild(summary);
            }
            
            // Set MECS eligibility
            const mecsDiv = document.getElementById('mecs-eligibility');
            const isEmergency = recommendation.combinedUrgency === 'emergency';
            const mecsProtocol = mecsProtocols[selectedCondition];
            
            if (!mecsProtocol || !mecsProtocol.eligible || isEmergency) {
                mecsDiv.innerHTML = `
                    <div class="mecs-not-eligible">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        NOT MECS ELIGIBLE - Requires secondary care
                    </div>
                `;
            } else {
                mecsDiv.innerHTML = `
                    <div class="mecs-eligible">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        MECS eligible - follow local commissioning pathway
                    </div>
                `;
            }
            
            // Set optometry management
            const optometryManagementList = document.getElementById('optometry-management');
            optometryManagementList.innerHTML = '';
            
            const optometryManagement = Array.isArray(recommendation.optometry.management) ? 
                recommendation.optometry.management : [recommendation.optometry.management];
            
            optometryManagement.forEach(step => {
                const li = document.createElement('li');
                li.className = 'management-item';
                li.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    ${step}
                `;
                optometryManagementList.appendChild(li);
            });
            
            // Set optometry medications
            const optometryMedicationsList = document.getElementById('optometry-medications-list');
            const optometryMedicationsBox = document.getElementById('optometry-medications-box');
            optometryMedicationsList.innerHTML = '';
            
            const optometryMedProtocol = medicationProtocols[selectedCondition]?.[recommendation.optometry.urgency];
            if (optometryMedProtocol && optometryMedProtocol.medications.length > 0) {
                optometryMedicationsBox.style.display = 'block';
                optometryMedProtocol.medications.forEach(med => {
                    const li = document.createElement('li');
                    li.className = 'management-item';
                    li.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        ${med}
                    `;
                    optometryMedicationsList.appendChild(li);
                });
                
                if (optometryMedProtocol.notes) {
                    const noteItem = document.createElement('li');
                    noteItem.className = 'management-item';
                    noteItem.style.fontStyle = 'italic';
                    noteItem.style.marginTop = '0.5rem';
                    noteItem.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        ${optometryMedProtocol.notes}
                    `;
                    optometryMedicationsList.appendChild(noteItem);
                }
            } else {
                optometryMedicationsBox.style.display = 'none';
            }
            
            // Set ophthalmology triage
            document.getElementById('ophthalmology-triage').textContent = 
                `${recommendation.ophthalmology.urgency.toUpperCase()} - ${recommendation.ophthalmology.condition}`;
            
            // Set ophthalmology management
            const ophthalmologyManagementList = document.getElementById('ophthalmology-management');
            ophthalmologyManagementList.innerHTML = '';
            
            recommendation.ophthalmology.management.forEach(step => {
                const li = document.createElement('li');
                li.className = 'management-item';
                li.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    ${step}
                `;
                ophthalmologyManagementList.appendChild(li);
            });
            
            // Set ophthalmology medications
            const ophthalmologyMedicationsList = document.getElementById('ophthalmology-medications-list');
            const ophthalmologyMedicationsBox = document.getElementById('ophthalmology-medications-box');
            ophthalmologyMedicationsList.innerHTML = '';
            
            const ophthalmologyMedProtocol = medicationProtocols[selectedCondition]?.[recommendation.ophthalmology.urgency];
            if (ophthalmologyMedProtocol && ophthalmologyMedProtocol.medications.length > 0) {
                ophthalmologyMedicationsBox.style.display = 'block';
                ophthalmologyMedProtocol.medications.forEach(med => {
                    const li = document.createElement('li');
                    li.className = 'management-item';
                    li.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        ${med}
                    `;
                    ophthalmologyMedicationsList.appendChild(li);
                });
                
                if (ophthalmologyMedProtocol.notes) {
                    const noteItem = document.createElement('li');
                    noteItem.className = 'management-item';
                    noteItem.style.fontStyle = 'italic';
                    noteItem.style.marginTop = '0.5rem';
                    noteItem.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        ${ophthalmologyMedProtocol.notes}
                    `;
                    ophthalmologyMedicationsList.appendChild(noteItem);
                }
            } else {
                ophthalmologyMedicationsBox.style.display = 'none';
            }
            
            // Set documentation requirements
            const formsList = document.getElementById('forms-list');
            formsList.innerHTML = '';
            
            const forms = [
                "GOS18 referral form (generate below)",
                "Clinical findings documentation",
                "Visual acuity recording",
                "Patient information leaflet",
                recommendation.combinedUrgency !== 'emergency' && mecsProtocol?.eligible ? "MECS claim form" : null
            ].filter(Boolean);
            
            forms.forEach(form => {
                const li = document.createElement('li');
                li.className = 'forms-item';
                li.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    ${form}
                `;
                formsList.appendChild(li);
            });
            
            // Set safety-netting advice
            const safetyList = document.getElementById('safety-list');
            safetyList.innerHTML = '';
            
            const safetyAdvice = safetyNettingConfig[selectedCondition]?.[recommendation.combinedUrgency] || [
                "Return immediately if symptoms worsen",
                "Seek urgent care if new symptoms develop",
                "Attend all follow-up appointments",
                "Contact emergency services if concerned"
            ];
            
            safetyAdvice.forEach(advice => {
                const li = document.createElement('li');
                li.className = 'safety-item';
                li.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    ${advice}
                `;
                safetyList.appendChild(li);
            });
            
            // Update debug info
            const debugPercentage = Math.round((recommendation.severityScore / maxScore) * 100);
            document.getElementById('debug-urgency').textContent = recommendation.combinedUrgency;
            document.getElementById('debug-score').textContent = `${recommendation.severityScore}/${maxScore} (${debugPercentage}%)`;
            document.getElementById('debug-match').textContent = 
                `Optometry: ${recommendation.optometry.urgency}, Ophthalmology: ${recommendation.ophthalmology.urgency}`;
            document.getElementById('debug-pathway').textContent = 
                recommendation.optometry === recommendation.ophthalmology ? 'Aligned' : 'Different pathways';
            
            window.scrollTo(0, 0);
        }

        function toggleMECSAccordion() {
            const content = document.getElementById('mecs-protocol-content');
            const toggle = document.getElementById('mecs-toggle');
            const header = document.querySelector('.mecs-protocol-header');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                // Add summary when collapsed
                if (!header.querySelector('.accordion-summary')) {
                    const summary = document.createElement('div');
                    summary.className = 'accordion-summary';
                    if (recommendation?.mecsCondition) {
                        summary.innerHTML = `<strong>MECS ELIGIBLE</strong> â€¢ ${recommendation.mecsCondition}`;
                    } else {
                        summary.innerHTML = `<strong>NOT MECS ELIGIBLE</strong> â€¢ Exceeds scope`;
                    }
                    header.appendChild(summary);
                }
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                // Remove summary when expanded
                const summary = header.querySelector('.accordion-summary');
                if (summary) {
                    summary.remove();
                }
            }
        }

        function togglePathwayAccordion(pathway) {
            const content = document.getElementById(`${pathway}-content`);
            const toggle = document.getElementById(`${pathway}-toggle`);
            const header = content.parentElement.querySelector('.pathway-header');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                // Add summary when collapsed
                if (!header.querySelector('.accordion-summary')) {
                    const summary = document.createElement('div');
                    summary.className = 'accordion-summary';
                    if (pathway === 'optometry') {
                        const urgency = recommendation?.optometry?.urgency || 'Assessment';
                        const condition = recommendation?.optometry?.condition || 'Clinical management';
                        summary.innerHTML = `<strong style="text-transform: uppercase;">${urgency}</strong> â€¢ ${condition}`;
                    } else {
                        const urgency = recommendation?.ophthalmology?.urgency || 'Assessment';
                        const condition = recommendation?.ophthalmology?.condition || 'Hospital pathway';
                        summary.innerHTML = `<strong style="text-transform: uppercase;">${urgency}</strong> â€¢ ${condition}`;
                    }
                    header.appendChild(summary);
                }
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                // Remove summary when expanded
                const summary = header.querySelector('.accordion-summary');
                if (summary) {
                    summary.remove();
                }
            }
        }

        function startOver() {
            currentStep = 'welcome';
            selectedCondition = null;
            responses = {};
            currentQuestionIndex = 0;
            assessmentPath = [];
            recommendation = null;
            questionHistory = [];
            
            // Clear any accordion summaries
            document.querySelectorAll('.accordion-summary').forEach(summary => summary.remove());
            
            // Reset accordion states
            document.querySelectorAll('.accordion-toggle').forEach(toggle => toggle.classList.remove('expanded'));
            document.querySelectorAll('.pathway-content, .mecs-protocol-content').forEach(content => content.classList.remove('expanded'));
            
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('assessment-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('enhanced-indicator').style.display = 'none';
            
            window.scrollTo(0, 0);
        }

        function toggleGOS18Form() {
            const container = document.getElementById('gos18-form-container');
            container.classList.toggle('hidden');
            
            if (!container.classList.contains('hidden')) {
                populateGOS18Form();
            }
        }

        function hideGOS18Form() {
            const container = document.getElementById('gos18-form-container');
            container.classList.add('hidden');
        }

        function downloadGOS18() {
            // Call the existing PDF generation function
            generateTextBasedPDF();
        }

        function generateTextBasedPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const form = document.getElementById('gos18-form');
            const formData = new FormData(form);
            
            // Get checkbox values properly
            const checkboxes = {};
            form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkboxes[checkbox.name] = checkbox.checked;
            });
            
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            let yPos = 20;
            
            // Helper function to add section header
            function addSectionHeader(title) {
                if (yPos > 250) {
                    pdf.addPage();
                    yPos = 20;
                }
                pdf.setFillColor(230, 230, 230);
                pdf.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text(title, margin + 2, yPos + 5.5);
                pdf.setFont(undefined, 'normal');
                yPos += 12;
            }
            
            // GOS 18 Header
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('GOS 18', margin, yPos);
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            pdf.text('Referral/Notification (Always at optometrist)', margin + 30, yPos);
            yPos += 6;
            pdf.text('Please contact the patient if they do not contact you or do not attend', margin, yPos);
            yPos += 12;
            
            // CONSULTATION DATE / Patient Details Section
            addSectionHeader('CONSULTATION DATE / Patient Details');
            
            // Patient details using autoTable
            pdf.autoTable({
                startY: yPos,
                margin: { left: margin, right: margin },
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 20 },
                    1: { cellWidth: 40 },
                    2: { fontStyle: 'bold', cellWidth: 20 },
                    3: { cellWidth: 40 },
                    4: { fontStyle: 'bold', cellWidth: 20 },
                    5: { cellWidth: 40 }
                },
                body: [
                    ['Title:', formData.get('title') || '', 'DoB:', formData.get('dob') || '', 'Address:', formData.get('address') || ''],
                    ['Surname:', formData.get('surname') || '', 'Tel (H):', formData.get('telHome') || '', '', ''],
                    ['First Names:', formData.get('firstName') || '', 'Tel (M):', formData.get('telMobile') || '', '', '']
                ]
            });
            
            yPos = pdf.lastAutoTable.finalY + 5;
            
            // Add Other and Post Code
            pdf.autoTable({
                startY: yPos,
                margin: { left: margin, right: margin },
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 20 },
                    1: { cellWidth: 'auto' }
                },
                body: [
                    ['Other:', formData.get('other') || ''],
                    ['Post Code:', formData.get('postcode') || '']
                ]
            });
            
            yPos = pdf.lastAutoTable.finalY + 10;
            
            // GP Details / Optometrist Details Section
            addSectionHeader('GP Details / Optometrist Details');
            
            pdf.autoTable({
                startY: yPos,
                margin: { left: margin, right: margin },
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 25 },
                    1: { cellWidth: 55 },
                    2: { fontStyle: 'bold', cellWidth: 25 },
                    3: { cellWidth: 55 }
                },
                body: [
                    ['Name Address:', formData.get('gpName') || '', 'Name Address:', formData.get('optName') || ''],
                    ['E-Mail:', formData.get('gpEmail') || '', 'E-Mail:', formData.get('optEmail') || ''],
                    ['Tel:', formData.get('gpTel') || '', 'Tel:', formData.get('optTel') || '']
                ]
            });
            
            yPos = pdf.lastAutoTable.finalY + 10;
            
            // Latest Spectacle Prescription Section
            addSectionHeader('Latest Spectacle Prescription');
            
            pdf.autoTable({
                startY: yPos,
                margin: { left: margin, right: margin },
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 1.5, halign: 'center' },
                headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 15 },
                    1: { cellWidth: 18 },
                    2: { cellWidth: 18 },
                    3: { cellWidth: 18 },
                    4: { cellWidth: 18 },
                    5: { cellWidth: 18 },
                    6: { cellWidth: 22 },
                    7: { cellWidth: 18 },
                    8: { cellWidth: 18 },
                    9: { cellWidth: 18 }
                },
                head: [['Rx', 'Vision', 'Sph', 'Cyl', 'Axis', 'VA', 'Dist. Prism\nPH Acuity', 'Add', 'Nr. Prism', 'Near VA']],
                body: [
                    [
                        'RE',
                        formData.get('reVision') || '',
                        formData.get('reSph') || '',
                        formData.get('reCyl') || '',
                        formData.get('reAxis') || '',
                        formData.get('reVA') || '',
                        formData.get('reDistPrism') || '',
                        formData.get('reAdd') || '',
                        formData.get('reNrPrism') || '',
                        formData.get('reNearVA') || ''
                    ],
                    [
                        'LE',
                        formData.get('leVision') || '',
                        formData.get('leSph') || '',
                        formData.get('leCyl') || '',
                        formData.get('leAxis') || '',
                        formData.get('leVA') || '',
                        formData.get('leDistPrism') || '',
                        formData.get('leAdd') || '',
                        formData.get('leNrPrism') || '',
                        formData.get('leNearVA') || ''
                    ]
                ]
            });
            
            yPos = pdf.lastAutoTable.finalY + 10;
            
            // IT Fields / Provisional Diagnosis Section
            addSectionHeader('IT Fields / Provisional Diagnosis');
            
            // Imaging checkboxes
            let checkboxY = yPos;
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'bold');
            pdf.text('Imaging:', margin, checkboxY);
            
            // Draw checkboxes
            const imagingOptions = [
                { name: 'imaging1', label: 'Enclosed', x: margin + 25 },
                { name: 'imaging2', label: 'Emailed', x: margin + 60 },
                { name: 'imaging3', label: 'Sent with patient', x: margin + 95 }
            ];
            
            pdf.setFont(undefined, 'normal');
            imagingOptions.forEach(option => {
                pdf.rect(option.x, checkboxY - 3, 3, 3);
                if (checkboxes[option.name]) {
                    pdf.setFontSize(10);
                    pdf.text('âœ“', option.x - 0.5, checkboxY + 0.5);
                    pdf.setFontSize(9);
                }
                pdf.text(option.label, option.x + 5, checkboxY);
            });
            
            yPos = checkboxY + 8;
            
            // Clinical findings
            pdf.setFont(undefined, 'bold');
            const clinicalTitle = 'Salient Symptoms, Signs, History, Clinical Findings, Reason for Referral and Provisional Diagnosis:';
            pdf.text(clinicalTitle, margin, yPos);
            yPos += 5;
            
            const clinicalFindings = formData.get('clinicalFindings') || '';
            const findingsTable = [[clinicalFindings]];
            
            pdf.autoTable({
                startY: yPos,
                margin: { left: margin, right: margin },
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 3, valign: 'top' },
                columnStyles: { 0: { cellWidth: 'auto' } },
                body: findingsTable,
                didDrawCell: function(data) {
                    if (data.row.index === 0) {
                        // Set minimum height for the clinical findings box
                        if (data.cell.height < 30) {
                            data.cell.height = 30;
                        }
                    }
                }
            });
            
            yPos = pdf.lastAutoTable.finalY + 10;
            
            // Safety-Netting Advice Section
            addSectionHeader('Safety-Netting Advice Given to Patient');
            
            pdf.setFont(undefined, 'bold');
            pdf.text('Patient advised regarding symptoms requiring immediate return:', margin, yPos);
            yPos += 5;
            
            const safetyAdvice = formData.get('safetyNettingAdvice') || '';
            const safetyTable = [[safetyAdvice]];
            
            pdf.autoTable({
                startY: yPos,
                margin: { left: margin, right: margin },
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 3, valign: 'top' },
                columnStyles: { 0: { cellWidth: 'auto' } },
                body: safetyTable,
                didDrawCell: function(data) {
                    if (data.row.index === 0 && data.cell.height < 25) {
                        data.cell.height = 25;
                    }
                }
            });
            
            yPos = pdf.lastAutoTable.finalY + 10;
            
            // Check for page break before Referral section
            if (yPos > 200) {
                pdf.addPage();
                yPos = 20;
            }
            
            // Referral Section
            addSectionHeader('Referral');
            
            // Referral urgency checkboxes
            pdf.setFontSize(9);
            const referralOptions = [
                { name: 'referralHES', label: 'HES' },
                { name: 'referralOcular', label: 'Ocular Emergency - to Hospital A&E Eye Service' },
                { name: 'referralSemi', label: 'Semi-Urgent - to HES within 4 weeks' },
                { name: 'referralRoutine', label: 'Routine - to HES within 12 weeks' }
            ];
            
            referralOptions.forEach(option => {
                pdf.rect(margin, yPos - 3, 3, 3);
                if (checkboxes[option.name]) {
                    pdf.setFontSize(10);
                    pdf.text('âœ“', margin - 0.5, yPos + 0.5);
                    pdf.setFontSize(9);
                }
                pdf.text(option.label, margin + 5, yPos);
                yPos += 6;
            });
            
            yPos += 5;
            
            // Supervised by section
            pdf.setFont(undefined, 'bold');
            pdf.text('Supervised by:', margin, yPos);
            pdf.setFont(undefined, 'normal');
            yPos += 6;
            
            // Supervised checkboxes in three columns
            const supervisedOptions = [
                ['supervisedCataract', 'Cataract'],
                ['supervisedGeneral', 'General (Medical/Ophthalmology)'],
                ['supervisedDiabetic', 'Diabetic/Dis/Adv'],
                ['supervisedLow', 'Low Vision'],
                ['supervisedOther', 'Other Medical Retinal'],
                ['supervisedGlaucoma', 'Glaucoma'],
                ['supervisedSquint', 'Squint/Ocular Motility'],
                ['supervisedYAG', 'YAG Laser'],
                ['supervisedAdnexal', 'Paed: Adnexal/Orbits'],
                ['supervisedExternal', 'External Eye/Adnexa'],
                ['supervisedOrtho', 'Orthoptics'],
                ['supervisedMacular', 'Macular/Intravitreal'],
                ['supervisedPaed', 'Paed: General/Refrac']
            ];
            
            const colWidth = 60;
            let col = 0;
            let rowY = yPos;
            
            supervisedOptions.forEach((option, index) => {
                if (index > 0 && index % 5 === 0) {
                    col++;
                    rowY = yPos;
                }
                
                const x = margin + (col * colWidth);
                pdf.rect(x, rowY - 3, 3, 3);
                if (checkboxes[option[0]]) {
                    pdf.setFontSize(10);
                    pdf.text('âœ“', x - 0.5, rowY + 0.5);
                    pdf.setFontSize(9);
                }
                pdf.text(option[1], x + 5, rowY);
                rowY += 5;
            });
            
            yPos = rowY + 8;
            
            // Not otherwise specified
            pdf.setFont(undefined, 'bold');
            pdf.text('Not otherwise specified:', margin, yPos);
            pdf.setFont(undefined, 'normal');
            pdf.text(formData.get('notSpecified') || '', margin + 40, yPos);
            
            yPos += 8;
            
            // Other referral options
            const otherOptions = [
                ['referralGP', 'GP (For Systemic management or appropriate)'],
                ['referralNotification', 'Notification Only']
            ];
            
            otherOptions.forEach(option => {
                pdf.rect(margin, yPos - 3, 3, 3);
                if (checkboxes[option[0]]) {
                    pdf.setFontSize(10);
                    pdf.text('âœ“', margin - 0.5, yPos + 0.5);
                    pdf.setFontSize(9);
                }
                pdf.text(option[1], margin + 5, yPos);
                yPos += 6;
            });
            
            yPos += 10;
            
            // Optometrist Name / Date Section
            addSectionHeader('Optometrist Name / Date');
            
            pdf.autoTable({
                startY: yPos,
                margin: { left: margin, right: margin },
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 20 },
                    1: { cellWidth: 40 },
                    2: { fontStyle: 'bold', cellWidth: 20 },
                    3: { cellWidth: 30 },
                    4: { fontStyle: 'bold', cellWidth: 15 },
                    5: { cellWidth: 35 }
                },
                body: [[
                    'Signature:',
                    formData.get('optSignature') || '',
                    'GOC No:',
                    formData.get('gocNumber') || '',
                    'Date:',
                    formData.get('referralDate') || ''
                ]]
            });
            
            // Footer note
            yPos = pdf.lastAutoTable.finalY + 10;
            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            const footerText = 'Please obtain consent from the patient if not already given, and provide feedback to the referring optometrist';
            pdf.text(footerText, margin, yPos);
            
            const filename = `GOS18_${selectedCondition.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(filename);
        }

        function emailGOS18() {
            try {
                // Get form element
                const form = document.getElementById('gos18-form');
                const data = {};
                
                // Extract all form data properly
                form.querySelectorAll('input[type="text"], input[type="date"], input[type="tel"], input[type="email"], textarea').forEach(input => {
                    data[input.name] = input.value || '';
                });
                
                form.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    data[checkbox.name] = true;
                });
                
                let emailBody = 'GOS 18 - REFERRAL/NOTIFICATION\n';
                emailBody += '================================\n\n';
                
                emailBody += 'PATIENT DETAILS:\n';
                emailBody += `Name: ${data.title || ''} ${data.firstName || ''} ${data.surname || ''}\n`;
                emailBody += `DOB: ${data.dob || ''}\n`;
                emailBody += `Address: ${data.address || ''}\n`;
                emailBody += `Postcode: ${data.postcode || ''}\n`;
                emailBody += `Tel (H): ${data.telHome || ''} | Tel (M): ${data.telMobile || ''}\n\n`;
                
                emailBody += 'CLINICAL SUMMARY:\n';
                emailBody += `Condition: ${selectedCondition}\n`;
                emailBody += `Urgency: ${recommendation.combinedUrgency.toUpperCase()}\n`;
                emailBody += `Severity Score: ${recommendation.severityScore || 'N/A'}\n`;
                emailBody += `Provisional Diagnosis: ${recommendation.optometry.condition}\n\n`;
                
                emailBody += 'CLINICAL FINDINGS:\n';
                emailBody += `${data.clinicalFindings || ''}\n\n`;
                
                emailBody += 'SAFETY-NETTING ADVICE GIVEN:\n';
                emailBody += `${data.safetyNettingAdvice || ''}\n\n`;
                
                // Add referral urgency
                emailBody += 'REFERRAL TYPE:\n';
                if (data.referralOcular) emailBody += 'âœ“ Ocular Emergency - to Hospital A&E Eye Service\n';
                if (data.referralSemi) emailBody += 'âœ“ Semi-Urgent - to HES within 4 weeks\n';
                if (data.referralRoutine) emailBody += 'âœ“ Routine - to HES within 12 weeks\n';
                if (data.referralGP) emailBody += 'âœ“ GP (For Systemic management)\n';
                emailBody += '\n';
                
                emailBody += `Referral Date: ${data.referralDate || new Date().toISOString().split('T')[0]}\n`;
                emailBody += `Optometrist: ${data.optSignature || ''}\n`;
                emailBody += `GOC Number: ${data.gocNumber || ''}\n`;
                
                const subject = `GOS18 Referral - ${selectedCondition} - ${recommendation.combinedUrgency.toUpperCase()} - ${data.surname || 'Patient'}`;
                
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                window.open(mailtoLink, '_blank');
                
                alert('Email client opened. Please remember to attach the GOS18 PDF using the Download PDF button if required.');
                
            } catch (error) {
                console.error('Error generating email:', error);
                alert('Unable to open email client. Please copy the form data manually.');
            }
        }

        function copyAssessmentResults() {
            const maxScore = maxScores[selectedCondition] || 20;
            const severityPercentage = Math.round((recommendation.severityScore / maxScore) * 100);
            
            let resultText = `EyeSpecialist.ai Assessment Results\n\n`;
            resultText += `Condition: ${selectedCondition}\n`;
            resultText += `Severity Score: ${recommendation.severityScore}/${maxScore} (${severityPercentage}%)\n`;
            resultText += `MECS Eligibility: ${recommendation.mecsCondition ? 'YES' : 'NO'}\n\n`;
            
            if (recommendation.mecsCondition) {
                resultText += `MECS Protocol: ${recommendation.mecsCondition}\n\n`;
            }
            
            resultText += `OPTOMETRY PATHWAY:\n`;
            resultText += `Urgency: ${recommendation.optometry.urgency.toUpperCase()}\n`;
            resultText += `Diagnosis: ${recommendation.optometry.condition}\n`;
            resultText += `Management: ${Array.isArray(recommendation.optometry.management) ? 
                recommendation.optometry.management.join('; ') : recommendation.optometry.management}\n\n`;
            
            resultText += `OPHTHALMOLOGY PATHWAY (if referred):\n`;
            resultText += `Urgency: ${recommendation.ophthalmology.urgency.toUpperCase()}\n`;
            resultText += `Diagnosis: ${recommendation.ophthalmology.condition}\n`;
            resultText += `Management: ${recommendation.ophthalmology.management.join('; ')}\n\n`;
            
            resultText += `Clinical Reasoning:\n${recommendation.optometry.reasoning}\n`;
            
            navigator.clipboard.writeText(resultText).then(() => {
                const button = document.getElementById('copy-button');
                button.textContent = 'Copied!';
                button.classList.add('copy-success');
                
                setTimeout(() => {
                    button.textContent = 'Copy Assessment';
                    button.classList.remove('copy-success');
                }, 2000);
            });
        }

        // Voice Dictation System
        class VoiceDictation {
            constructor() {
                this.recognition = null;
                this.isListening = false;
                this.currentField = null;
                this.voiceEnabled = true;
                this.setupRecognition();
                this.createVoiceControls();
                this.initializeVoiceButtons();
            }

            setupRecognition() {
                // Check for browser support
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    console.warn('Speech recognition not supported in this browser');
                    this.showStatus('Voice dictation is not supported in your browser. Please use Chrome, Edge, or Safari.', 'error');
                    return;
                }

                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.lang = 'en-GB'; // Set to British English for UK users
                
                // Configure recognition events
                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.updateButtonState('recording');
                    this.showStatus('Listening... Speak now', 'info');
                };

                this.recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0])
                        .map(result => result.transcript)
                        .join('');

                    if (this.currentField) {
                        // Handle different field types
                        if (this.currentField.type === 'date') {
                            // Try to parse date from speech
                            const dateValue = this.parseDateFromSpeech(transcript);
                            if (dateValue) {
                                this.currentField.value = dateValue;
                            }
                        } else {
                            // For text fields, append or replace based on context
                            if (event.results[0].isFinal) {
                                if (this.currentField.value && !this.shouldReplace) {
                                    this.currentField.value += ' ' + transcript;
                                } else {
                                    this.currentField.value = transcript;
                                }
                            }
                        }
                    }
                };

                this.recognition.onerror = (event) => {
                    this.isListening = false;
                    this.updateButtonState('idle');
                    
                    switch(event.error) {
                        case 'no-speech':
                            this.showStatus('No speech detected. Please try again.', 'warning');
                            break;
                        case 'audio-capture':
                            this.showStatus('No microphone found. Please check your settings.', 'error');
                            break;
                        case 'not-allowed':
                            this.showStatus('Microphone access denied. Please enable permissions.', 'error');
                            break;
                        default:
                            this.showStatus(`Error: ${event.error}`, 'error');
                    }
                };

                this.recognition.onend = () => {
                    this.isListening = false;
                    this.updateButtonState('idle');
                    this.showStatus('Voice input complete', 'success');
                };
            }

            createVoiceControls() {
                // Create voice control panel
                const controlPanel = document.createElement('div');
                controlPanel.className = 'voice-control-panel';
                controlPanel.innerHTML = `
                    <button class="voice-toggle-btn" onclick="voiceDictation.toggleVoice()">
                        <svg viewBox="0 0 24 24" width="16" height="16">
                            <path fill="currentColor" d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                        </svg>
                        <span id="voice-toggle-text">Voice Input ON</span>
                    </button>
                    <div class="voice-instructions">
                        Click the microphone icon next to any field to dictate text.
                        Say "comma", "period", or "new line" for punctuation.
                    </div>
                `;
                document.body.appendChild(controlPanel);

                // Create status indicator
                const statusDiv = document.createElement('div');
                statusDiv.className = 'voice-status';
                statusDiv.id = 'voice-status';
                document.body.appendChild(statusDiv);
            }

            initializeVoiceButtons() {
                // Wait for GOS18 form to be visible
                const observer = new MutationObserver((mutations) => {
                    const formContainer = document.getElementById('gos18-form-container');
                    if (formContainer && !formContainer.classList.contains('hidden')) {
                        this.addVoiceButtonsToForm();
                        // Show voice control panel when form is visible
                        document.querySelector('.voice-control-panel').classList.add('show');
                    } else {
                        // Hide voice control panel when form is hidden
                        document.querySelector('.voice-control-panel').classList.remove('show');
                    }
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeFilter: ['class']
                });
            }

            addVoiceButtonsToForm() {
                const form = document.getElementById('gos18-form');
                if (!form || !this.voiceEnabled) return;

                // Select all text inputs, textareas, and date inputs
                const fields = form.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], input[type="date"], textarea');
                
                fields.forEach(field => {
                    // Skip if already has voice button
                    if (field.parentElement.querySelector('.voice-button')) return;
                    
                    // Create wrapper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'voice-input-wrapper';
                    
                    // Wrap the field
                    field.parentNode.insertBefore(wrapper, field);
                    wrapper.appendChild(field);
                    
                    // Add voice-enabled class to input
                    field.classList.add('voice-enabled-input');
                    
                    // Create voice button
                    const voiceBtn = document.createElement('button');
                    voiceBtn.type = 'button';
                    voiceBtn.className = 'voice-button';
                    voiceBtn.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                        </svg>
                    `;
                    
                    // Add click handler
                    voiceBtn.onclick = (e) => {
                        e.preventDefault();
                        this.toggleDictation(field);
                    };
                    
                    wrapper.appendChild(voiceBtn);
                });
            }

            toggleDictation(field) {
                if (!this.recognition) {
                    this.showStatus('Voice recognition not available', 'error');
                    return;
                }

                if (this.isListening) {
                    this.recognition.stop();
                } else {
                    this.currentField = field;
                    this.shouldReplace = field.value.length === 0;
                    
                    // Request microphone permission and start
                    this.recognition.start();
                }
            }

            updateButtonState(state) {
                if (!this.currentField) return;
                
                const wrapper = this.currentField.parentElement;
                const button = wrapper.querySelector('.voice-button');
                
                if (button) {
                    button.className = `voice-button ${state}`;
                    
                    // Update icon based on state
                    if (state === 'recording') {
                        button.innerHTML = `
                            <svg viewBox="0 0 24 24">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                            </svg>
                        `;
                    } else {
                        button.innerHTML = `
                            <svg viewBox="0 0 24 24">
                                <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                            </svg>
                        `;
                    }
                }
            }

            showStatus(message, type) {
                const statusDiv = document.getElementById('voice-status');
                statusDiv.textContent = message;
                statusDiv.className = 'voice-status show';
                
                // Style based on type
                switch(type) {
                    case 'error':
                        statusDiv.style.background = 'rgba(220, 38, 38, 0.9)';
                        break;
                    case 'warning':
                        statusDiv.style.background = 'rgba(245, 158, 11, 0.9)';
                        break;
                    case 'success':
                        statusDiv.style.background = 'rgba(16, 185, 129, 0.9)';
                        break;
                    default:
                        statusDiv.style.background = 'rgba(0, 0, 0, 0.8)';
                }
                
                // Auto-hide after 3 seconds
                setTimeout(() => {
                    statusDiv.classList.remove('show');
                }, 3000);
            }

            toggleVoice() {
                this.voiceEnabled = !this.voiceEnabled;
                const toggleBtn = document.getElementById('voice-toggle-text');
                toggleBtn.textContent = this.voiceEnabled ? 'Voice Input ON' : 'Voice Input OFF';
                
                // Remove voice buttons if disabled
                if (!this.voiceEnabled) {
                    document.querySelectorAll('.voice-button').forEach(btn => btn.remove());
                    document.querySelectorAll('.voice-enabled-input').forEach(input => {
                        input.classList.remove('voice-enabled-input');
                    });
                } else {
                    this.addVoiceButtonsToForm();
                }
            }

            parseDateFromSpeech(speech) {
                // Simple date parsing - can be enhanced
                const months = {
                    'january': '01', 'february': '02', 'march': '03', 'april': '04',
                    'may': '05', 'june': '06', 'july': '07', 'august': '08',
                    'september': '09', 'october': '10', 'november': '11', 'december': '12'
                };
                
                // Try to match patterns like "15th January 2024"
                const datePattern = /(\d{1,2})\w*\s+(\w+)\s+(\d{4})/i;
                const match = speech.match(datePattern);
                
                if (match) {
                    const day = match[1].padStart(2, '0');
                    const month = months[match[2].toLowerCase()] || '01';
                    const year = match[3];
                    return `${year}-${month}-${day}`;
                }
                
                return null;
            }
        }

        // Initialize voice dictation when document is ready
        let voiceDictation;
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('EyeSpecialist.ai loading...');
                
                // Initialize voice dictation
                voiceDictation = new VoiceDictation();
                console.log('Voice dictation initialized');
                
                // Initialize the main application
                displayConditions();
                console.log('Application loaded successfully');
                
                // Hide loading indicator
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error initializing application:', error);
                // Show error message to user
                document.body.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h2>Error Loading Application</h2>
                        <p>There was an error loading EyeSpecialist.ai</p>
                        <p>Error: ${error.message}</p>
                        <button onclick="location.reload()">Reload Page</button>
                    </div>
                `;
            }
        });

        // Add window error handler
        window.addEventListener('error', function(event) {
            console.error('Runtime error:', event.error);
        });

        // Voice command shortcuts for common medical terms
        const medicalVocabulary = {
            // Conditions
            'conjunctivitis': 'conjunctivitis',
            'uveitis': 'uveitis',
            'keratitis': 'keratitis',
            'glaucoma': 'glaucoma',
            'cataract': 'cataract',
            'retinal detachment': 'retinal detachment',
            'macular degeneration': 'macular degeneration',
            
            // Medications
            'chloramphenicol': 'chloramphenicol',
            'prednisolone': 'prednisolone',
            'timolol': 'timolol',
            'latanoprost': 'latanoprost',
            
            // Abbreviations (spoken -> written)
            'visual acuity': 'VA',
            'intraocular pressure': 'IOP',
            'right eye': 'RE',
            'left eye': 'LE',
            'both eyes': 'BE'
        };

        // Enhance speech recognition with medical vocabulary
        if (window.SpeechGrammarList) {
            const speechRecognitionList = new window.SpeechGrammarList();
            const grammar = '#JSGF V1.0; grammar medical; public <medical> = ' + 
                Object.keys(medicalVocabulary).join(' | ') + ' ;';
            speechRecognitionList.addFromString(grammar, 1);
        }
    </script>
</body>
</html>
                 "
